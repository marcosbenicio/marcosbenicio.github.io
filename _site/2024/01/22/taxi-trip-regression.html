<!DOCTYPE html>




<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta property="og:image" content="/assets/img/post5/cluster_map_dropoff_pickup_boroughs.png"/>
    
    
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax_highlight.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="atom.xml" />

    <!-- MathJax Configuration -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            processEscapes: true
          }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

    <script>
      function show_tag_section(tag) {
        // Hide all other tag divs
        document.getElementById('all_posts').style.display = 'none';
        var tag_divs = document.getElementsByClassName('by_tag');
        var i;
        for (var i = 0; i < tag_divs.length; i++) {
          tag_divs[i].style.display = 'none';
        }
        // Show the one we want
        document.getElementById(tag).style.display = 'block';
      }
    </script>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Analysis of Taxi Trip Duration in NYC | Marcos Benício</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Analysis of Taxi Trip Duration in NYC" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this project, we will build a machine learning model to predict the trip duration of taxi rides in New York City. The dataset is from Kaggle. The original dataset have approximately 1.4 million entries for the training set and 630k for the test set, although only the training set is used in this project. The dataset is then preprocessed, outliers are removed, and new features are created, followed by splitting it into train, test, and validation sets. The goal is to predict the trip duration of taxi trips in New York City. The evaluation metric used for this project is the Root Mean Squared Logarithmic Error (RMSLE). The RMSLE is calculated by taking the log of the predictions and actual values. This metric ensures that errors in predicting short trip durations are less penalized compared to errors in predicting longer ones. For this purpose, we employ three types of machine learning models: mini-batch k-means to create new cluster features for the locations, and the Decision Tree Regressor and XGBoost to predict the trip duration." />
<meta property="og:description" content="In this project, we will build a machine learning model to predict the trip duration of taxi rides in New York City. The dataset is from Kaggle. The original dataset have approximately 1.4 million entries for the training set and 630k for the test set, although only the training set is used in this project. The dataset is then preprocessed, outliers are removed, and new features are created, followed by splitting it into train, test, and validation sets. The goal is to predict the trip duration of taxi trips in New York City. The evaluation metric used for this project is the Root Mean Squared Logarithmic Error (RMSLE). The RMSLE is calculated by taking the log of the predictions and actual values. This metric ensures that errors in predicting short trip durations are less penalized compared to errors in predicting longer ones. For this purpose, we employ three types of machine learning models: mini-batch k-means to create new cluster features for the locations, and the Decision Tree Regressor and XGBoost to predict the trip duration." />
<link rel="canonical" href="http://localhost:4000/2024/01/22/taxi-trip-regression.html" />
<meta property="og:url" content="http://localhost:4000/2024/01/22/taxi-trip-regression.html" />
<meta property="og:site_name" content="Marcos Benício" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-22T00:00:00-03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Analysis of Taxi Trip Duration in NYC" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-01-22T00:00:00-03:00","datePublished":"2024-01-22T00:00:00-03:00","description":"In this project, we will build a machine learning model to predict the trip duration of taxi rides in New York City. The dataset is from Kaggle. The original dataset have approximately 1.4 million entries for the training set and 630k for the test set, although only the training set is used in this project. The dataset is then preprocessed, outliers are removed, and new features are created, followed by splitting it into train, test, and validation sets. The goal is to predict the trip duration of taxi trips in New York City. The evaluation metric used for this project is the Root Mean Squared Logarithmic Error (RMSLE). The RMSLE is calculated by taking the log of the predictions and actual values. This metric ensures that errors in predicting short trip durations are less penalized compared to errors in predicting longer ones. For this purpose, we employ three types of machine learning models: mini-batch k-means to create new cluster features for the locations, and the Decision Tree Regressor and XGBoost to predict the trip duration.","headline":"Analysis of Taxi Trip Duration in NYC","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/01/22/taxi-trip-regression.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/profile_photo.png"}},"url":"http://localhost:4000/2024/01/22/taxi-trip-regression.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body onload="show_tag_section('all_posts')">

    <div class="header">

      <!-- Large header banner on left for large display widths -->
      <div class="big_header">

        <!-- Name -->
        <div class="name_group">
          <h1><a href="/">Marcos Benício</a></h1>
        </div>

        <!-- <a href=""><img src="/assets/img/profile_photo.png" alt="Logo" class="center_img" ></a>-->
        <a href="/"><img src="/assets/img/profile_photo.png" alt="Logo" class="center_img" ></a>
        <!--<a href=""><img src="/assets/img/profile_photo.png" alt="Logo" class="center_img" ></a>-->



        <!-- Position + company -->
        <div class="link_group">

          <div class="row">
              <div class="col1">
                <span> M.sc in Physics</span>
              </div>
          </div>

          <div class="row">
            <!-- <a href=""-->
              <div class="col1">
                <img src="/assets/img/brazil_icon.png" height="30" width="30">
                <!-- <span>  </span>-->
              </div>
            </a>
          </div>

          <div class="row">
            <div class="col1">
              <img src="/assets/img/place_icon_light.png" height="16" width="16">
              <span> Niterói, RJ </span>
            </div>
          </div>

        </div>

        <!-- Badges/links -->
        <div class="link_group">

          <div class="row">
            <a href="https://github.com/marcosbenicio">
              <div class="col2">
                <img src="/assets/img/github_icon_light.png" height="16" width="16">
                <span> Github </span>
              </div>
            </a>
            <a href="https://linkedin.com/in/marcos-benício-de-andrade-alonso-415a5b16b">
              <div class="col2">
                <img src="/assets/img/linkedin_icon_light.png" height="16" width="16">
                <span> LinkedIn </span>
              </div>
            </a>
          </div>

          <div class="row">
            <a href="mailto:marcosbenicio0102@gmail.com">
              <div class="col2">
                <img src="/assets/img/email_icon_light.png" height="16" width="16">
                <span> Email </span>
              </div>
            </a>
            <a href="/assets/files/resume.pdf">
              <div class="col2">
                <img src="/assets/img/cv_icon_light.png" height="16" width="16">
                <span> Resume </span>
              </div>
            </a>
          </div>

        </div>

      </div>

      <!-- Smaller header banner on top for small display widths -->
      <div class="small_header">

        <!-- Name -->
        <div class="small_header_box">
          <div class="name_header_box">
            <div class="name_header_img">
              <a href="/">
                <img src="/assets/img/profile_photo.png" alt="Logo" height="60">
              </a>
            </div>
            <div class="name_header_name">
              <h1><a href="/">Marcos Benício</a></h1>
            </div>
          </div>
        </div>

        <!-- Position + Company -->
        <div class="small_header_box">
          <div class="row">
            <div class="col1">
              <span> M.sc in Physics </span>
            </div>
          </div>
          <div class="row">
            <div class="col1">
             <!-- <a href=""> -->
                  <img src="/assets/img/brazil_icon.png" height="30" width="30">
                  <!-- <span>  </span> -->
              </a>
            </div>
          </div>
        </div>

        <!-- Badges/links -->
        <div class="small_header_box">
                <div class="row">
                  <a href="https://github.com/marcosbenicio">
                    <div class="col2">
                      <img src="/assets/img/github_icon_light.png" height="16" width="16">
                      <span> Github </span>
                    </div>
                  </a>
                  <a href="https://linkedin.com/in/marcos-benício-de-andrade-alonso-415a5b16b">
                    <div class="col2">
                      <img src="/assets/img/linkedin_icon_light.png" height="16" width="16">
                      <span> LinkedIn </span>
                    </div>
                  </a>
                </div>

                <div class="row">
                  <a href="mailto:marcosbenicio0102@gmail.com">
                    <div class="col2">
                      <img src="/assets/img/email_icon_light.png" height="16" width="16">
                      <span> Email </span>
                    </div>
                  </a>
                  <a href="/assets/files/resume.pdf">
                    <div class="col2">
                      <img src="/assets/img/cv_icon_light.png" height="16" width="16">
                      <span> Resume </span>
                    </div>
                  </a>
                </div>
        </div>

      </div>

    </div>

    <!-- Page content -->
    <div class="content">

      <h1>Analysis of Taxi Trip Duration in NYC</h1>
<p class="meta">22 Jan 2024 - Tags: Regression, XGBoost, Decision Tree, and K-means clustering</p>

<div class="button_container">
  
    <a href="https://github.com/marcosbenicio/taxi-trip-regression">
      <div class="button_link">
        View on<br /><strong>Github</strong>
      </div>
    </a>
  
  
  
</div>


<div class="post">
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">TF_CPP_MIN_LOG_LEVEL</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">2</span><span class="sh">'</span> 
<span class="c1"># 0 = all messages are logged (default behavior)
# 1 = INFO messages are not printed
# 2 = INFO and WARNING messages are not printed
# 3 = INFO, WARNING, and ERROR messages are not printed
</span>
<span class="c1"># Ensure python module are found
</span><span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sh">'</span><span class="s">../src</span><span class="sh">'</span><span class="p">)</span>
<span class="kn">from</span> <span class="n">models.train_model</span> <span class="kn">import</span> <span class="n">train_xgboost</span>

<span class="c1"># Data visualization 
</span><span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib.collections</span> <span class="kn">import</span> <span class="n">EllipseCollection</span>
<span class="kn">from</span> <span class="n">matplotlib.colors</span> <span class="kn">import</span>  <span class="n">Normalize</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="c1"># Data manipulation 
</span><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># Geospatial 
</span><span class="kn">from</span> <span class="n">geopy</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>

<span class="c1"># Machine learning
</span><span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="n">sklearn.tree</span> <span class="kn">import</span>  <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="n">sklearn.cluster</span> <span class="kn">import</span> <span class="n">MiniBatchKMeans</span>
<span class="kn">from</span> <span class="n">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">mutual_info_classif</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">make_scorer</span>
<span class="kn">import</span> <span class="n">xgboost</span> <span class="k">as</span> <span class="n">xgb</span>


<span class="kn">import</span> <span class="n">requests</span>

<span class="c1"># Random state 
</span><span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

<span class="c1"># Palette color for plots
</span><span class="n">yellow</span> <span class="o">=</span><span class="sh">'</span><span class="s">#dfdc7bff</span><span class="sh">'</span>
<span class="n">grey</span> <span class="o">=</span> <span class="sh">'</span><span class="s">#50566dff</span><span class="sh">'</span>
<span class="n">beige</span> <span class="o">=</span> <span class="sh">'</span><span class="s">#d9cebfff</span><span class="sh">'</span>
<span class="n">orange</span> <span class="o">=</span> <span class="sh">'</span><span class="s">#e5b97bff</span><span class="sh">'</span>
</code></pre></div></div>

<h1 id="outline"><strong>Outline</strong></h1>

<ul>
  <li><a href="#1-data-preprocessing"><strong>1. Data Preprocessing</strong></a></li>
  <li><a href="#2-outliers"><strong>2. Outlier</strong></a></li>
  <li><a href="#3-feature-engineering"><strong>3. Feature Engineering</strong></a>
    <ul>
      <li><a href="#31-datetime-features">3.1. Datetime Features</a></li>
      <li><a href="#32-traffic-features">3.2. Traffic Features</a></li>
      <li><a href="#33-distance-features">3.3. Distance Features</a></li>
      <li><a href="#34-weather-features">3.4. Weather Features</a></li>
      <li><a href="#35-cluster-features">3.5. Cluster Features</a></li>
    </ul>
  </li>
  <li><a href="#4-split-data"><strong>4. Split Data</strong></a></li>
  <li><a href="#5-exploratory-data-analysis-(eda)"><strong>5. Exploratory Data Analysis (EDA)</strong></a>
    <ul>
      <li><a href="#51-feature-visualization">5.1. Feature Visualization</a></li>
      <li><a href="#52-feature-correlations">5.2. Feature Correlations</a></li>
      <li><a href="#53-conclusion-from-eda">5.3. Conclusion from EDA</a></li>
    </ul>
  </li>
  <li><a href="#6-model-training-and-validation"><strong>6. Model Training and Validation</strong></a></li>
  <li><a href="#7-model-evaluation-on-test-set"><strong>7. Model Evaluation on Test Set</strong></a></li>
  <li><a href="#8-conclusion"><strong>8. Conclusion</strong></a></li>
  <li><a href="#9-deployment"><strong>9. Deployment</strong></a>
    <ul>
      <li><a href="#91-testing-local-and-web-service">9.1 Testing Local and Web Service</a></li>
    </ul>
  </li>
</ul>

<p>In this project, we will build a machine learning model to predict the trip duration of taxi rides in New York City. The dataset is from <a href="https://www.kaggle.com/competitions/nyc-taxi-trip-duration">Kaggle</a>. The original dataset has approximately 1.4 million entries for the training set and 630k for the test set, although only the training set is utilized in this project. The dataset is then preprocessed, outliers are removed, and new features are created, followed by splitting it into train, test, and validation sets.</p>

<p>The goal is to predict the trip duration of taxi rides in New York City. The evaluation metric is the Root Mean Squared Logarithmic Error (RMSLE). The RMSLE is calculated by taking the log of the predictions and actual values. This metric ensures that errors in predicting short trip durations are less penalized compared to errors in predicting longer ones. For this purpose, we employ three types of machine learning models: mini-batch k-means to create new cluster features for the locations, and the Decision Tree Regressor and XGBoost to predict the trip duration.</p>

<p>Initially, the dataset has just 11 columns, offering great possibilities for developing new features and visualizations. The dataset has the following features:</p>

<ul>
  <li>
    <p><strong>id</strong> - a unique identifier for each trip.</p>
  </li>
  <li>
    <p><strong>vendor_id</strong> - a code indicating the provider associated with the trip record.</p>
  </li>
  <li>
    <p><strong>pickup_datetime</strong> - date and time when the meter was engaged.</p>
  </li>
  <li>
    <p><strong>dropoff_datetime</strong> - date and time when the meter was disengaged.</p>
  </li>
  <li>
    <p><strong>passenger_count</strong> - the number of passengers in the vehicle (driver entered value).</p>
  </li>
  <li>
    <p><strong>pickup_longitude</strong> - the longitude where the meter was engaged.</p>
  </li>
  <li>
    <p><strong>pickup_latitude</strong> - the latitude where the meter was engaged.</p>
  </li>
  <li>
    <p><strong>dropoff_longitude</strong> - the longitude where the meter was disengaged.</p>
  </li>
  <li>
    <p><strong>dropoff_latitude</strong> - the latitude where the meter was disengaged.</p>
  </li>
  <li>
    <p><strong>store_and_fwd_flag</strong> - This flag indicates whether the trip record was held in vehicle memory before sending to the vendor because the vehicle did not have a connection to the server Y=store and forward; N=not a store and forward trip.</p>
  </li>
  <li>
    <p><strong>trip_duration</strong> - duration of the trip in seconds.</p>
  </li>
</ul>

<h1 id="1-data-preprocessing"><strong>1. Data Preprocessing</strong></h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/raw/nyc-yellow-taxi-trip-2016.csv</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">dropoff_datetime</span><span class="sh">'</span><span class="p">])</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Shape:</span><span class="sh">"</span><span class="p">,</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>pickup_datetime</th>
      <th>dropoff_datetime</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>2016-03-14 17:24:55</td>
      <td>2016-03-14 17:32:30</td>
      <td>1</td>
      <td>-73.982155</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>2016-06-12 00:43:35</td>
      <td>2016-06-12 00:54:38</td>
      <td>1</td>
      <td>-73.980415</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>2016-01-19 11:35:24</td>
      <td>2016-01-19 12:10:48</td>
      <td>1</td>
      <td>-73.979027</td>
    </tr>
  </tbody>
</table>

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
      <th>trip_duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>N</td>
      <td>455</td>
    </tr>
    <tr>
      <th>1</th>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>N</td>
      <td>663</td>
    </tr>
    <tr>
      <th>2</th>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>N</td>
      <td>2124</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Shape: (1458644, 11)
</code></pre></div></div>

<p>Let’s check the dataset information, and see if there is any missing value or duplicated rows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s"> Duplicated rows:</span><span class="sh">"</span><span class="p">,</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">duplicated</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s"> Missing values:</span><span class="sh">"</span><span class="p">,</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1458644 entries, 0 to 1458643
Data columns (total 11 columns):
 #   Column              Non-Null Count    Dtype         
---  ------              --------------    -----         
 0   id                  1458644 non-null  object        
 1   vendor_id           1458644 non-null  int64         
 2   pickup_datetime     1458644 non-null  datetime64[ns]
 3   dropoff_datetime    1458644 non-null  datetime64[ns]
 4   passenger_count     1458644 non-null  int64         
 5   pickup_longitude    1458644 non-null  float64       
 6   pickup_latitude     1458644 non-null  float64       
 7   dropoff_longitude   1458644 non-null  float64       
 8   dropoff_latitude    1458644 non-null  float64       
 9   store_and_fwd_flag  1458644 non-null  object        
 10  trip_duration       1458644 non-null  int64         
dtypes: datetime64[ns](2), float64(4), int64(3), object(2)
memory usage: 122.4+ MB
None

 Duplicated rows: 0

 Missing values: 0
</code></pre></div></div>

<p>There are no missing values or duplicated rows. The only feature that we need to change is <code class="language-plaintext highlighter-rouge">store_and_fwd_flag</code>, which is a categorical feature ${N, Y}$. We will change it to a boolean mapping <code class="language-plaintext highlighter-rouge">Y</code> to <code class="language-plaintext highlighter-rouge">True</code>  and <code class="language-plaintext highlighter-rouge">N</code> to <code class="language-plaintext highlighter-rouge">False</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Map store_and_fwd_flag to True and False 
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">store_and_fwd_flag</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">store_and_fwd_flag</span><span class="sh">'</span><span class="p">].</span><span class="nf">map</span><span class="p">({</span><span class="sh">'</span><span class="s">N</span><span class="sh">'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">'</span><span class="s">Y</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
</code></pre></div></div>

<p>Let’s verify if the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> is correct by calculating the time difference between <code class="language-plaintext highlighter-rouge">dropoff_datetime</code> and <code class="language-plaintext highlighter-rouge">pickup_datetime</code> in seconds :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trip_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_datetime</span><span class="sh">'</span><span class="p">]</span> <span class="o">-</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">seconds</span>

<span class="n">is_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">trip_duration</span> <span class="o">!=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span> <span class="sh">'</span><span class="s">Number of incorrect values in trip_duration:</span><span class="sh">'</span><span class="p">,</span><span class="n">is_diff</span><span class="p">.</span><span class="nf">sum</span><span class="p">())</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="n">is_diff</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of incorrect values in trip_duration: 4
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>pickup_datetime</th>
      <th>dropoff_datetime</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>355003</th>
      <td>id1864733</td>
      <td>1</td>
      <td>2016-01-05 00:19:42</td>
      <td>2016-01-27 11:08:38</td>
      <td>1</td>
      <td>-73.789650</td>
    </tr>
    <tr>
      <th>680594</th>
      <td>id0369307</td>
      <td>1</td>
      <td>2016-02-13 22:38:00</td>
      <td>2016-03-08 15:57:38</td>
      <td>2</td>
      <td>-73.921677</td>
    </tr>
    <tr>
      <th>924150</th>
      <td>id1325766</td>
      <td>1</td>
      <td>2016-01-05 06:14:15</td>
      <td>2016-01-31 01:01:07</td>
      <td>1</td>
      <td>-73.983788</td>
    </tr>
    <tr>
      <th>978383</th>
      <td>id0053347</td>
      <td>1</td>
      <td>2016-02-13 22:46:52</td>
      <td>2016-03-25 18:18:14</td>
      <td>1</td>
      <td>-73.783905</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
      <th>trip_duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>355003</th>
      <td>40.643559</td>
      <td>-73.956810</td>
      <td>40.773087</td>
      <td>False</td>
      <td>1939736</td>
    </tr>
    <tr>
      <th>680594</th>
      <td>40.735252</td>
      <td>-73.984749</td>
      <td>40.759979</td>
      <td>False</td>
      <td>2049578</td>
    </tr>
    <tr>
      <th>924150</th>
      <td>40.742325</td>
      <td>-73.985489</td>
      <td>40.727676</td>
      <td>False</td>
      <td>2227612</td>
    </tr>
    <tr>
      <th>978383</th>
      <td>40.648632</td>
      <td>-73.978271</td>
      <td>40.750202</td>
      <td>False</td>
      <td>3526282</td>
    </tr>
  </tbody>
</table>
</div>

<p>It appears that there are four extreme values in the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> that don’t make sense. We can correct then by substituting the values of the actual trip duration in seconds that was calculated. Let’s simple substitute for the correct column that we calculate:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_duration</span>

<span class="c1"># Let's check again
</span><span class="n">is_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">trip_duration</span> <span class="o">!=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span> <span class="sh">'</span><span class="s">Number of incorrect values in trip_duration:</span><span class="sh">'</span><span class="p">,</span><span class="n">is_diff</span><span class="p">.</span><span class="nf">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of incorrect values in trip_duration: 0
</code></pre></div></div>

<h1 id="2-outliers"><strong>2. Outliers</strong></h1>

<p>To identify outliers in the dataset, we will employ geospatial visualization for the pickup and dropoff locations and the interquartile range (IQR) with a box plot to detect outliers in the <code class="language-plaintext highlighter-rouge">trip_duration</code>. First, let’s examine all features with data types <code class="language-plaintext highlighter-rouge">float64</code> and <code class="language-plaintext highlighter-rouge">int64</code> in the dataset:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip_filtered</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">float64</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">int64</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip_filtered</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1458644 entries, 0 to 1458643
Data columns (total 6 columns):
 #   Column             Non-Null Count    Dtype  
---  ------             --------------    -----  
 0   vendor_id          1458644 non-null  int64  
 1   passenger_count    1458644 non-null  int64  
 2   pickup_longitude   1458644 non-null  float64
 3   pickup_latitude    1458644 non-null  float64
 4   dropoff_longitude  1458644 non-null  float64
 5   dropoff_latitude   1458644 non-null  float64
dtypes: float64(4), int64(2)
memory usage: 66.8 MB



None
</code></pre></div></div>

<h2 id="21-location-features">2.1. Location Features</h2>

<p>When looking for outlier in the dataset, we should focus on numerical features. To find out if there is any outliers, we can analyze the features <code class="language-plaintext highlighter-rouge">pickup_longitude</code>, <code class="language-plaintext highlighter-rouge">pickup_latitude</code>, <code class="language-plaintext highlighter-rouge">dropoff_longitude</code>, <code class="language-plaintext highlighter-rouge">dropoff_latitude</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">trip_outliers</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

<span class="c1"># can be useful to separate the features
</span><span class="n">pickup_dropoff_features</span> <span class="o">=</span> <span class="p">[</span> <span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">,</span> 
                            <span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span> <span class="p">]</span>

<span class="n">pickup_long</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">]</span>
<span class="n">pickup_lat</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">]</span>
<span class="n">dropoff_long</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">]</span>
<span class="n">dropoff_lat</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># Summary statistics
</span><span class="nf">display</span><span class="p">(</span>    <span class="n">trip_outliers</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">)[</span><span class="n">pickup_dropoff_features</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span>
            <span class="p">.</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">]))</span>

<span class="nf">display</span><span class="p">(</span>    <span class="n">trip_outliers</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">)[</span><span class="n">pickup_dropoff_features</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
            <span class="p">.</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">]))</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">pickup_longitude</th>
      <th colspan="3" halign="left">pickup_latitude</th>
    </tr>
    <tr>
      <th></th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
    </tr>
    <tr>
      <th>passenger_count</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-74.042969</td>
      <td>-73.957256</td>
      <td>-73.776367</td>
      <td>40.598701</td>
      <td>40.736596</td>
      <td>40.871922</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-79.569733</td>
      <td>-73.973551</td>
      <td>-65.897385</td>
      <td>36.118538</td>
      <td>40.751209</td>
      <td>51.881084</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-121.933342</td>
      <td>-73.973343</td>
      <td>-61.335529</td>
      <td>34.359695</td>
      <td>40.749811</td>
      <td>41.319164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-75.455917</td>
      <td>-73.974312</td>
      <td>-73.722374</td>
      <td>39.803932</td>
      <td>40.750224</td>
      <td>41.189957</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-75.354332</td>
      <td>-73.973836</td>
      <td>-73.559799</td>
      <td>34.712234</td>
      <td>40.749328</td>
      <td>40.945747</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-74.191154</td>
      <td>-73.972432</td>
      <td>-71.799896</td>
      <td>35.081532</td>
      <td>40.750801</td>
      <td>40.925323</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-74.145752</td>
      <td>-73.973227</td>
      <td>-73.653358</td>
      <td>40.213837</td>
      <td>40.751611</td>
      <td>40.896381</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-74.173668</td>
      <td>-73.948100</td>
      <td>-73.631149</td>
      <td>40.715031</td>
      <td>40.740285</td>
      <td>40.768551</td>
    </tr>
    <tr>
      <th>8</th>
      <td>-73.992653</td>
      <td>-73.992653</td>
      <td>-73.992653</td>
      <td>40.768719</td>
      <td>40.768719</td>
      <td>40.768719</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-73.710632</td>
      <td>-73.710632</td>
      <td>-73.710632</td>
      <td>40.671581</td>
      <td>40.671581</td>
      <td>40.671581</td>
    </tr>
  </tbody>
</table>
</div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">dropoff_longitude</th>
      <th colspan="3" halign="left">dropoff_latitude</th>
    </tr>
    <tr>
      <th></th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
    </tr>
    <tr>
      <th>passenger_count</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-74.188072</td>
      <td>-73.963539</td>
      <td>-73.776360</td>
      <td>40.598701</td>
      <td>40.735779</td>
      <td>40.872318</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-80.355431</td>
      <td>-73.973371</td>
      <td>-65.897385</td>
      <td>36.118538</td>
      <td>40.751977</td>
      <td>43.911762</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-121.933304</td>
      <td>-73.973464</td>
      <td>-61.335529</td>
      <td>34.359695</td>
      <td>40.751070</td>
      <td>43.921028</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-74.550011</td>
      <td>-73.974016</td>
      <td>-73.055977</td>
      <td>40.435646</td>
      <td>40.751601</td>
      <td>41.387001</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-74.569748</td>
      <td>-73.974422</td>
      <td>-73.170937</td>
      <td>32.181141</td>
      <td>40.750786</td>
      <td>41.029831</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-79.352837</td>
      <td>-73.973206</td>
      <td>-72.954590</td>
      <td>40.436329</td>
      <td>40.751590</td>
      <td>41.281796</td>
    </tr>
    <tr>
      <th>6</th>
      <td>-74.220955</td>
      <td>-73.973192</td>
      <td>-73.524658</td>
      <td>40.553467</td>
      <td>40.752375</td>
      <td>40.982738</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-74.173660</td>
      <td>-73.948097</td>
      <td>-73.631149</td>
      <td>40.715019</td>
      <td>40.740289</td>
      <td>40.768551</td>
    </tr>
    <tr>
      <th>8</th>
      <td>-74.041374</td>
      <td>-74.041374</td>
      <td>-74.041374</td>
      <td>40.729954</td>
      <td>40.729954</td>
      <td>40.729954</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-73.710632</td>
      <td>-73.710632</td>
      <td>-73.710632</td>
      <td>40.671581</td>
      <td>40.671581</td>
      <td>40.671581</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can observe that there are unrealistic values for <code class="language-plaintext highlighter-rouge">passenger_count</code>.  The expected values for <code class="language-plaintext highlighter-rouge">passenger_count</code> are between 1 and 6, but there are  atypical counts of 0 and values greater than 6. Let’s remove those outliers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Boolean series for passenger count outliers
</span><span class="n">passenger_outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>

<span class="n">not_outliers</span> <span class="o">=</span> <span class="o">~</span><span class="n">passenger_outliers</span>
<span class="n">trip_outliers</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="n">not_outliers</span><span class="p">]</span>


<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Outliers in passenger_count: </span><span class="si">{</span><span class="n">passenger_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outliers in passenger_count: 65
</code></pre></div></div>

<p>The boxplot for detecting outliers relies on the assumption that the data has a distribution close to normal (Gaussian), which is often not true with geospatial coordinates due to their unique patterns influenced by urban roads and traffic. Therefore, we will use a different approach to identify outliers in the location features.</p>

<p>For pickup and dropoff locations, the strategy is to use geospatial data using shapfile from <a href="https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm">NYC Borough Boundaries</a> to identify points that fall outside the boundaries of NYC map as outliers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_points_map</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gdf_map</span><span class="p">,</span> <span class="n">geometry_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">within_map</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                    <span class="n">color_map</span><span class="o">=</span><span class="sh">'</span><span class="s">beige</span><span class="sh">'</span><span class="p">,</span> <span class="n">color_points</span><span class="o">=</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Plots a map with points from a DataFrame onto a given Axes object.

    Parameters:
    - df: DataFrame with the coordinates to plot.
    - gdf_map: GeoDataFrame of the map boundaries.
    - geometry_col: GeoDataFrame column with geometry data.
    - ax: Matplotlib Axes object to plot on.
    - title: Title of the plot.
    - within_map: If True, only plots points within the map boundaries.
    - color_map: Color for the map.
    - color_points: Color for the points.
    </span><span class="sh">"""</span>
    <span class="c1"># convert to the same coordinate reference system
</span>    <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry_col</span><span class="p">)</span>
    <span class="c1"># convert to the same coordinate reference system
</span>    <span class="n">gdf_points</span><span class="p">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="p">.</span><span class="n">crs</span>
    
    <span class="c1"># If within_map is True, perform spatial join with the map boundaries
</span>    <span class="c1"># only points within the boundaries will be plotted
</span>    <span class="k">if</span> <span class="n">within_map</span><span class="p">:</span>
        <span class="n">gdf_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">sjoin</span><span class="p">(</span><span class="n">gdf_points</span><span class="p">,</span> <span class="n">gdf_map</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">inner</span><span class="sh">"</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="sh">'</span><span class="s">within</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># Update the original DataFrame 
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf_points</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>
        
    <span class="c1"># Plot the map and the points
</span>    <span class="n">gdf_map</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">grey</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">gdf_points</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color_points</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nybb_path</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../data/external/nyc-borough-boundaries/geo_export_e13eede4-6de2-4ed8-98a0-58290fd6b0fa.shp</span><span class="sh">'</span>
<span class="n">nyc_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="n">nybb_path</span><span class="p">)</span>

<span class="c1"># Creating the geometry for points
</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">],</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># Creating the plot
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">pickup_within_nyc</span> <span class="o">=</span> <span class="nf">plot_points_map</span><span class="p">(</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">,</span> <span class="n">gdf_map</span> <span class="o">=</span> <span class="n">nyc_boundary</span><span class="p">,</span> 
                                        <span class="n">geometry_col</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span>  <span class="sh">'</span><span class="s">Pickup Locations</span><span class="sh">'</span><span class="p">,</span>
                                        <span class="n">color_map</span><span class="o">=</span> <span class="n">beige</span><span class="p">,</span> <span class="n">color_points</span><span class="o">=</span> <span class="n">orange</span>  <span class="p">)</span> 

<span class="c1"># Showing the plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Number of outliers removed: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">trip_outliers</span><span class="p">)</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">pickup_within_nyc</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/map_pickup.png" width="800" height="700" />
</center>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of outliers removed: 1216
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">geometry</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">pickup_within_nyc</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">],</span> 
                                <span class="n">pickup_within_nyc</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">pickup_dropoff_within_nyc</span> <span class="o">=</span> <span class="nf">plot_points_map</span><span class="p">(</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">pickup_within_nyc</span><span class="p">,</span> <span class="n">gdf_map</span> <span class="o">=</span> <span class="n">nyc_boundary</span><span class="p">,</span> 
                                                <span class="n">geometry_col</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span>  <span class="sh">'</span><span class="s">Dropoff Locations</span><span class="sh">'</span><span class="p">,</span>
                                                <span class="n">color_map</span><span class="o">=</span> <span class="n">beige</span><span class="p">,</span> <span class="n">color_points</span><span class="o">=</span> <span class="n">orange</span>  <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Number of outliers removed:</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">pickup_within_nyc</span><span class="p">)</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">pickup_dropoff_within_nyc</span><span class="p">)</span><span class="si">}</span><span class="sh">'</span> <span class="p">)</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/map_dropoff.png" width="800" height="700" />
</center>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of outliers removed:5359
</code></pre></div></div>

<h2 id="22-target-feature-trip-duration">2.2. Target Feature (Trip Duration)</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Copy the dataset with removed outliers from locations
</span><span class="n">trip_outliers</span> <span class="o">=</span> <span class="n">pickup_dropoff_within_nyc</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>The interquartile range (IQR)</strong></p>

<p>The IQR gives a sense of how spread out the values in a dataset are and is a robust measure of dispersion that is not influenced by outliers.</p>

<p>A quartile divides data into four equal parts, each comprising 25% of the data. $Q_1$ represents the 25th percentile of the data, meaning 25% of data points are less than or equal to this value. $Q_3$ represents the 75th percentile, implying that 75% of data points are less than or equal to this value.</p>

<p>Let’s calculate the IQR for the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> and plot a blox plot to visualize the outliers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">boxplot_stats</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">whis</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Calculate the statistics for a box plot.

    Returns:
    dict: A dictionary containing the quartiles, IQR, and whisker limits.
    </span><span class="sh">"""</span>
    <span class="n">Q1</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">Q2</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.50</span><span class="p">)</span>
    <span class="n">Q3</span> <span class="o">=</span> <span class="n">series</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>

    <span class="n">lower_whisker</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="n">whis</span> <span class="o">*</span> <span class="n">IQR</span>
    <span class="n">upper_whisker</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="n">whis</span> <span class="o">*</span> <span class="n">IQR</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">Q1</span><span class="sh">'</span><span class="p">:</span> <span class="n">Q1</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Q2</span><span class="sh">'</span><span class="p">:</span> <span class="n">Q2</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Q3</span><span class="sh">'</span><span class="p">:</span> <span class="n">Q3</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">IQR</span><span class="sh">'</span><span class="p">:</span> <span class="n">IQR</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">lower_whis</span><span class="sh">'</span><span class="p">:</span> <span class="n">lower_whisker</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">upper_whis</span><span class="sh">'</span><span class="p">:</span> <span class="n">upper_whisker</span>
    <span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">plot_distribution_boxplot</span><span class="p">(</span>  <span class="n">series</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">''</span><span class="p">,</span> <span class="n">log1p</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                <span class="n">draw_quartiles</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Plot the distribution and boxplot of a series on given axes.

    Args:
    - series (pandas.Series): The series to plot.
    - ax1 (matplotlib.axes.Axes): The axes for the histogram.
    - ax2 (matplotlib.axes.Axes): The axes for the boxplot.
    - title (str): The title of the plot.
    - label (str): The label for the x-axis.
    - log1p (bool): If True, applies log1p transformation to the series.
    - draw_quartiles (bool): If True, draws quartile lines on the histogram.
    - kde (bool): If True, plots a KDE over the histogram.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">log1p</span><span class="p">:</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="nf">boxplot_stats</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

    <span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>   <span class="n">series</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">#dfdc7bff</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="n">kde</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
    <span class="n">ax1</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s"> Histogram</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax1</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">series</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">#dfdc7bff</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
                <span class="n">fliersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">flierprops</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">color</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">#50566dff</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">markeredgecolor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">#50566dff</span><span class="sh">'</span><span class="p">})</span>
    
    <span class="n">ax2</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s"> Boxplot</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">draw_quartiles</span><span class="p">:</span>
        <span class="n">quartiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">Q1</span><span class="sh">'</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">Q3</span><span class="sh">'</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">lower_whis</span><span class="sh">'</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">upper_whis</span><span class="sh">'</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">quartiles</span><span class="p">:</span>
            <span class="n">ax1</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">#50566dff</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">y_center</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">.</span><span class="nf">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax1</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span>   <span class="n">line</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nf">plot_distribution_boxplot</span><span class="p">(</span>  <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">],</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Trip Duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Log of Trip Duration (s)</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/taxi_trip_duration_distribution.png" width="800" height="400" />
</center>

<p>Because of the high values and zeros in the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code>, we apply the logarithmic transformation $\log(x+1)$. This transformation reduces the effect of outliers and the overall variance in the dataset.The histogram, illustrated in the first plot, resembles a bell curve after applying this transformation. From the boxplot, we can see:</p>

<ul>
  <li>
    <p>The first and third quartiles ($Q_1$ and $Q_3$) representing the 25th and 75th percentiles, are:</p>

    <ul>
      <li>$Q_1 = 5.98$</li>
      <li>$Q_3 = 6.98$</li>
    </ul>
  </li>
  <li>The interquartile range (IQR) is the difference between the third and first quartiles:
    <ul>
      <li>IQR = $Q_3 - Q_1 = 0.99$</li>
    </ul>
  </li>
  <li>The whiskers indicate the range of the data:
    <ul>
      <li>The lower whisker :  $Q_1 - 1.5 IQR = 4.50$</li>
      <li>The upper whisker :  $Q_3 + 1.5 IQR = 8.46$</li>
    </ul>
  </li>
</ul>

<p>Data points outside the whiskers are potential outliers that need further validation. For better intuition, we convert these whisker values from the log scale back to the original scale in terms of hours ($\text{Hours} = \text{Seconds}/3600$ ):</p>

<p>\(\frac{\exp(4.50) - 1}{3600} \approx  0.024 ~~\text{hours}\)
\(\frac{\exp(8.46) - 1}{3600} \approx  1.32 ~~\text{hours}\)</p>

<p>The lower whisker corresponds to approximately 1.4 minutes, which is very short for a taxi trip duration, suggesting that these could be errors or special cases.The upper whisker suggests a more plausible trip duration of about 1.32 hours, but with very unrealistic high values with more than 20 hours of duration.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">count_outliers</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">whis</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Count the number of upper and lower outliers in the series and print their percentages.

        Args:
        series (pd.Series): Series for which to count outliers.

        Returns:
        (pd.Series, pd.Series): Two boolean series, one for upper outliers and one for lower outliers.
        </span><span class="sh">"""</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="nf">boxplot_stats</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">whis</span><span class="p">)</span>


        <span class="n">upper_outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">upper_whis</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">lower_outliers</span> <span class="o">=</span> <span class="p">(</span><span class="n">series</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="sh">'</span><span class="s">lower_whis</span><span class="sh">'</span><span class="p">])</span>

        <span class="c1"># Percentage of outliers 
</span>        <span class="n">percentage_upper</span> <span class="o">=</span> <span class="n">upper_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">percentage_lower</span> <span class="o">=</span> <span class="n">lower_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="nf">print</span><span class="p">(</span>  <span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Potential upper outliers: </span><span class="si">{</span><span class="n">upper_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
                <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">percentage_upper</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span>  <span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Potential lower outliers: </span><span class="si">{</span><span class="n">lower_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
                <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">percentage_lower</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">upper_outliers</span><span class="p">,</span> <span class="n">lower_outliers</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">log_trip_duration</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">])</span>
<span class="n">upper_duration_outliers</span><span class="p">,</span> <span class="n">lower_duration_outliers</span> <span class="o">=</span> <span class="nf">count_outliers</span><span class="p">(</span><span class="n">log_trip_duration</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Potential upper outliers: 4292 (0.30% of the dataset)

Potential lower outliers: 14461 (1.00% of the dataset)
</code></pre></div></div>

<p>Let’s compare the trip durations with some distance measures from the pickup location to the dropoff location. In an article on <a href="https://link.springer.com/article/10.1007/s13198-021-01130-x">New York City taxi trip duration prediction using MLP and XGBoost</a>, some distance measures were discussed, like Manhattan, haversine, and bearing distances. Unlike the straight-line Euclidean distance, the Manhattan distance calculates the sum of the absolute differences between the horizontal and vertical coordinates, which resembles navigating an actual grid of city streets.  However, this doesn’t account for the Earth’s curvature. To address this, the article also considers the haversine distance, which is more appropriate for large distances as it does account for the Earth’s curvature. Bearing distance calculates the direction between two points.</p>

<p>I will just adopt a simplified approach that still accounts for the Earth’s curvature. The Geodesic distance is the small path between two points on the surface of a curved object, for our case the Earth surface. To achieve This we use the <code class="language-plaintext highlighter-rouge">geopy</code> library:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function to calculate geodesic distance in a ellipsoid
</span><span class="k">def</span> <span class="nf">geodesic</span><span class="p">(</span><span class="n">start_lat</span><span class="p">,</span> <span class="n">start_long</span><span class="p">,</span> <span class="n">end_lat</span><span class="p">,</span> <span class="n">end_long</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Calculate geodesic distances between pickup and dropoff locations.

    Args:
    - start_lat, start_long, end_lat, end_long: Lists or arrays of coordinates 
    for the start point and end point.

    Returns:
    List of distances in meters for each pair of start and end points.
    </span><span class="sh">"""</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="nf">zip</span><span class="p">(</span><span class="n">start_lat</span><span class="p">,</span> <span class="n">start_long</span><span class="p">,</span> <span class="n">end_lat</span><span class="p">,</span> <span class="n">end_long</span><span class="p">)</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance</span><span class="p">.</span><span class="nf">distance</span><span class="p">((</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">),</span> <span class="p">(</span><span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">)).</span><span class="n">meters</span> <span class="k">for</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">distances</span>

<span class="c1"># Calculate the geodesic distance
</span><span class="n">geodesic_distance</span> <span class="o">=</span> <span class="nf">geodesic</span><span class="p">(</span>   <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">())</span>
</code></pre></div></div>

<p><strong>Potential Lower Outliers</strong></p>

<p>Approximately 1% of all trips have durations less than or equal to 1.4 minutes. Based on the table below, it appears that some of these trips may have been canceled, as indicated by a zero or minimal geodesic distance. Because our analysis aims to predict the trip duration, we will remove these potentially canceled trips from the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">trip_outlier_geodesics</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">geodesic_distance</span>

<span class="nf">display</span><span class="p">(</span>    <span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="n">lower_duration_outliers</span><span class="p">]</span>
            <span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">)[[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]]</span>
            <span class="p">.</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span>  <span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">])</span>   <span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="4" halign="left">trip_duration</th>
      <th colspan="4" halign="left">geodesic_distance</th>
    </tr>
    <tr>
      <th></th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>count</th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>count</th>
    </tr>
    <tr>
      <th>passenger_count</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>47.663972</td>
      <td>88</td>
      <td>11258</td>
      <td>0.0</td>
      <td>272.870639</td>
      <td>19983.682930</td>
      <td>11258</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>51.322023</td>
      <td>88</td>
      <td>1562</td>
      <td>0.0</td>
      <td>299.515846</td>
      <td>1823.852419</td>
      <td>1562</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>53.269321</td>
      <td>88</td>
      <td>427</td>
      <td>0.0</td>
      <td>315.255005</td>
      <td>1491.261959</td>
      <td>427</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>53.846890</td>
      <td>88</td>
      <td>209</td>
      <td>0.0</td>
      <td>302.298194</td>
      <td>1665.249710</td>
      <td>209</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>55.686591</td>
      <td>88</td>
      <td>619</td>
      <td>0.0</td>
      <td>347.513153</td>
      <td>1509.483335</td>
      <td>619</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>57.704663</td>
      <td>88</td>
      <td>386</td>
      <td>0.0</td>
      <td>364.417960</td>
      <td>1120.139579</td>
      <td>386</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>Potential Upper Outliers</strong></p>

<p>Approximately 0.30% of all trips have durations of 1.32 hours or less. In this case, a table alone does not give much information about these potential outliers; therefore, we employ a histogram to better visualize these potential upper outliers.</p>

<p>From the histogram, it is apparent that around 1700 trips have durations exceeding 20 hours. In contrast, a larger cluster of over 2000 trips has durations ranging between 1.32 hours and 4 hours. Considering this distribution, only those with durations longer than 4 hours may be classified as actual outliers, as durations less than 4 hours are within a plausible range for taxi trips in NYC.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">upper_outliers</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="n">upper_duration_outliers</span><span class="p">][</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">/</span><span class="mi">3600</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>  <span class="n">upper_outliers</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">axes</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">High Trip Duration Outliers</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Trip Duration (hours)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_center</span> <span class="o">=</span> <span class="n">axes</span><span class="p">.</span><span class="nf">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">axes</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">y_center</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="mi">4</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> hours</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/high_trip_outliers.png" width="800" height="400" />
</center>

<p>We observed that there are also unrealistic values for <code class="language-plaintext highlighter-rouge">geodesic_distance</code>. These unrealistic values can simple be deleted because they don’t represent a real patters for the trip duration. We’ll create variables to hold boolean series for each of the identified outliers conditions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Percentage of lower duration outliers
</span><span class="n">per_lower_duration</span> <span class="o">=</span> <span class="n">lower_duration_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">trip_outliers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Outliers with trip duration less than 1.4 minutes: </span><span class="si">{</span><span class="n">lower_duration_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
      <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">per_lower_duration</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>


<span class="c1"># Boolean series for trip durations over 4 hours
</span><span class="n">upper_duration_outliers</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3600</span>
<span class="n">per_upper_duration</span> <span class="o">=</span> <span class="n">upper_duration_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">trip_outliers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Outliers with trip duration greater than 4 hours: </span><span class="si">{</span><span class="n">upper_duration_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
      <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">per_upper_duration</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>


<span class="c1"># Boolean series for geodesic distance == zero
</span><span class="n">geodesic_outliers_zeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># Percentage of outliers
</span><span class="n">per_geodesic</span> <span class="o">=</span> <span class="n">geodesic_outliers_zeros</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Outliers with zero geodesic distances: </span><span class="si">{</span><span class="n">geodesic_outliers_zeros</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
      <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">per_geodesic</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outliers with trip duration less than 1.4 minutes: 14461 (1.00% of the dataset)

Outliers with trip duration greater than 4 hours: 2059 (0.14% of the dataset)

Outliers with zero geodesic distances: 5490 (0.38% of the dataset)
</code></pre></div></div>

<p><strong>Average Geodesic Velocity</strong></p>

<p>Before removing all this outliers that we identify, let’s first investigate one more aspect of the trip duration. As direct observations may not be sufficient to identify all outliers, we can calculate an average velocity based on the geodesic distances to provide a better understanding of potential outliers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate the average velocity in Km/h
</span><span class="n">geo_distance_km</span> <span class="o">=</span> <span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
<span class="n">trip_duration_hrs</span> <span class="o">=</span> <span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span>
<span class="n">velocity_geodesic_kmh</span> <span class="o">=</span> <span class="p">(</span><span class="n">geo_distance_km</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">trip_duration_hrs</span><span class="p">)</span>

<span class="c1"># For simplicity add velocity to the dataset
</span><span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_velocity_kmh</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocity_geodesic_kmh</span>


<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nf">plot_distribution_boxplot</span><span class="p">(</span>  <span class="n">trip_outlier_geodesics</span><span class="p">[</span><span class="sh">'</span><span class="s">avg_velocity_kmh</span><span class="sh">'</span><span class="p">],</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> 
                            <span class="sh">'</span><span class="s">Average Geodesic Velocity</span><span class="sh">'</span><span class="p">,</span> 
                            <span class="sh">'</span><span class="s">Log of Average Velocity (Km/h)</span><span class="sh">'</span>    <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>


<span class="n">log_velocity_geodesic</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">velocity_geodesic_kmh</span><span class="p">)</span>
<span class="n">upper_vel_outliers</span><span class="p">,</span> <span class="n">lower_vel_outliers</span> <span class="o">=</span> <span class="nf">count_outliers</span><span class="p">(</span><span class="n">log_velocity_geodesic</span><span class="p">)</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/trip_duration_vel_distribution.png" width="800" height="400" />
</center>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Potential upper outliers: 4950 (0.34% of the dataset)
    
Potential lower outliers: 23999 (1.65% of the dataset)
</code></pre></div></div>

<p>The lower and upper values for potential outliers are:</p>

<ul>
  <li>Lower whisker : ${\exp(1.39) - 1} \approx  3.0 ~~ km/h $</li>
  <li>Upper whisker : ${\exp(3.86) - 1} \approx  46.5 ~~ km/h $</li>
</ul>

<p>New York City is a metropolis known for its traffic congestion. The average speed of a taxi in New York City with passengers on board is 20.3 km/h, as reported in the article “<a href="https://www.researchgate.net/publication/320479557_Taxi_driver_speeding_who_when_where_and_how_A_comparative_study_between_Shanghai_and_New_York">Taxi driver speeding</a>”:</p>

<p>“… The average occupancy speed of taxi drivers in Shanghai (21.3 km/h) was similar to that of <strong>NYC (20.3 km/h)</strong>”</p>

<p>Considering that approximately 0.35% of the total number of trips have an average velocity greater than or equal to 46.5 km/h, these cases are not representative of typical taxi trips in NYC and thus can be removed.</p>

<h3 id="311-handling-outliers">3.1.1 Handling Outliers</h3>

<p>We will now address the outliers identified in the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> using the following steps</p>

<ol>
  <li>
    <p>Remove the <code class="language-plaintext highlighter-rouge">trip_duration</code>  less then or equal to 1.4 minutes. This will remove 1.00% of instances from the original dataset.</p>
  </li>
  <li>
    <p>Remove the <code class="language-plaintext highlighter-rouge">trip_duration</code>  greater than 4 hours. This will remove 0.14% of instances from the original dataset.</p>
  </li>
  <li>
    <p>Remove <code class="language-plaintext highlighter-rouge">geodesic_distance</code>  equal to 0.0 meters. This will remove 0.38% of instances from the original dataset.</p>
  </li>
  <li>
    <p>Remove the <code class="language-plaintext highlighter-rouge">trip_duration</code> corresponding to an average velocity greater than or equal to 46.5 km/h.  This will remove 0.34% of instances from the original dataset.</p>
  </li>
</ol>

<p>We will use the boolean series previously defined to create a single series that identifies an entry as an outlier if it meets any one of the outlier conditions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Combine all outlier conditions
</span><span class="n">all_outliers</span> <span class="o">=</span>  <span class="n">lower_duration_outliers</span> <span class="o">|</span> <span class="n">upper_duration_outliers</span> \
                <span class="o">|</span> <span class="n">geodesic_outliers_zeros</span> <span class="o">|</span> <span class="n">upper_vel_outliers</span>

<span class="n">not_outliers</span> <span class="o">=</span> <span class="o">~</span><span class="n">all_outliers</span>

<span class="c1"># filter the original by not_outliers
</span><span class="n">original_length</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">)</span>

<span class="n">per_outliers</span> <span class="o">=</span> <span class="n">all_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="o">/</span><span class="n">original_length</span> <span class="o">*</span> <span class="mi">100</span>
<span class="nf">print</span><span class="p">(</span>  <span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s">Outliers removed: </span><span class="si">{</span><span class="n">all_outliers</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> </span><span class="sh">'</span>
        <span class="sa">f</span><span class="sh">'</span><span class="s">(</span><span class="si">{</span><span class="n">per_outliers</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">% of the dataset)</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Outliers removed: 24848 (1.70% of the dataset)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">trip_outliers</span><span class="p">[</span><span class="n">not_outliers</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>


<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nf">plot_distribution_boxplot</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">],</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">Trip Duration</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Log of Trip Duration (s)</span><span class="sh">'</span><span class="p">)</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/trip_duration_nooutlier_distribution.png" width="800" height="400" />
</center>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># save the dataset
</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/interim/nyc-taxi-trip-2016-remove-outliers.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="3-feature-engineering"><strong>3. Feature Engineering</strong></h1>

<p>Before splitting the dataset and conducting the exploratory data analysis (EDA), let’s create some new features that will help in the model predictions and in the <a href="#5-exploratory-data-analysis-(eda)">Exploratory Data Analysis</a> section.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/interim/nyc-taxi-trip-2016-remove-outliers.csv</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="n">parse_dates</span><span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">dropoff_datetime</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="31-datetime-features">3.1. Datetime Features</h2>

<p>Using the pickup time with format <code class="language-plaintext highlighter-rouge">YYYY-MM-DD H:M:S</code>, let’s extract features like the year, month, day, hours and minutes for more informative features and also the time of day, day of the week, day of the year to help with possible underlying patters in the data related to specific time intervals. So we will create a total of 8 new features:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Days in a year: 1-365 (or 366)
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">day_of_year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">dayofyear</span>
<span class="c1"># Day of week: 0-6 (0 for Monday, 6 for Sunday)
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">dayofweek</span>
<span class="c1"># Hour of the day :0-23
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour_of_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">hour</span>
<span class="c1"># Minutes in a day: 0-1440
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">min_of_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">minute</span>

<span class="c1"># Date features
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">date</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">year</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">day</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">hour</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">minute</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">minute</span>

<span class="c1"># Drop datetime features, they are not necessary anymore
</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">pickup_datetime</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">taxi_trip</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">dropoff_datetime</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>1</td>
      <td>-73.982155</td>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>1</td>
      <td>-73.980415</td>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>1</td>
      <td>-73.979027</td>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_duration</th>
      <th>day_of_year</th>
      <th>day_of_week</th>
      <th>hour_of_day</th>
      <th>min_of_day</th>
      <th>pickup_date</th>
      <th>dropoff_date</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>minute</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>455</td>
      <td>74</td>
      <td>0</td>
      <td>17</td>
      <td>1044</td>
      <td>2016-03-14</td>
      <td>2016-03-14</td>
      <td>2016</td>
      <td>3</td>
      <td>14</td>
      <td>17</td>
      <td>24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>663</td>
      <td>164</td>
      <td>6</td>
      <td>0</td>
      <td>43</td>
      <td>2016-06-12</td>
      <td>2016-06-12</td>
      <td>2016</td>
      <td>6</td>
      <td>12</td>
      <td>0</td>
      <td>43</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2124</td>
      <td>19</td>
      <td>1</td>
      <td>11</td>
      <td>695</td>
      <td>2016-01-19</td>
      <td>2016-01-19</td>
      <td>2016</td>
      <td>1</td>
      <td>19</td>
      <td>11</td>
      <td>35</td>
    </tr>
  </tbody>
</table>
</div>

<p>Another relevant information is weekends and holidays. For this we will use the <a href="https://www.kaggle.com/datasets/pceccon/nyc2016holidays/data">holiday dataset from kaggle</a>, which contains the New York City holidays for the year of 2016. We will create two new binary features, <code class="language-plaintext highlighter-rouge">is_holiday</code> and <code class="language-plaintext highlighter-rouge">is_weekend</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">holidays</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/raw/nyc-holidays-2016.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="sh">'</span><span class="s">;</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">holidays</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Day</th>
      <th>Date</th>
      <th>Holiday</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Friday</td>
      <td>January 01</td>
      <td>New Years Day</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Monday</td>
      <td>January 18</td>
      <td>Martin Luther King Jr. Day</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Friday</td>
      <td>February 12</td>
      <td>Lincoln's Birthday</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Monday</td>
      <td>February 15</td>
      <td>Presidents' Day</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Sunday</td>
      <td>May 08</td>
      <td>Mother's Day</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert to datetime the Date column
</span><span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span> <span class="o">+</span> <span class="sh">'</span><span class="s">, 2016</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Extract month and day as numerical values
</span><span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
<span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">day</span>
<span class="c1"># Add the is_holiday column 
</span><span class="n">holidays</span><span class="p">[</span><span class="sh">'</span><span class="s">is_holiday</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># Drop the original columns
</span><span class="n">holidays</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Day</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Holiday</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Save the processed holidays dataset
</span><span class="n">holidays</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/external/nyc-holidays-2016.csv</span><span class="sh">'</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="nf">display</span><span class="p">(</span><span class="n">holidays</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>month</th>
      <th>day</th>
      <th>is_holiday</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>18</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>12</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>15</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>8</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<p>We will then use the <code class="language-plaintext highlighter-rouge">month</code> and <code class="language-plaintext highlighter-rouge">day</code> features to merge the taxi trip dataset with the holidays dataset using a left join:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Merge the taxi data with the holidays data
</span><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">holidays</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Replace NaN values in the is_holiday column with False
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">is_holiday</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Add the is_weekend column (5:Saturday or 6:Sunday)
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">is_weekend</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of trips in holiday:</span><span class="sh">'</span><span class="p">,</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">is_holiday</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>1</td>
      <td>-73.982155</td>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>1</td>
      <td>-73.980415</td>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>1</td>
      <td>-73.979027</td>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>id3504673</td>
      <td>2</td>
      <td>1</td>
      <td>-74.010040</td>
      <td>40.719971</td>
      <td>-74.012268</td>
      <td>40.706718</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>id2181028</td>
      <td>2</td>
      <td>1</td>
      <td>-73.973053</td>
      <td>40.793209</td>
      <td>-73.972923</td>
      <td>40.782520</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_duration</th>
      <th>day_of_year</th>
      <th>min_of_day</th>
      <th>pickup_date</th>
      <th>dropoff_date</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>minute</th>
      <th>is_holiday</th>
      <th>is_weekend</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>455</td>
      <td>74</td>
      <td>1044</td>
      <td>2016-03-14</td>
      <td>2016-03-14</td>
      <td>2016</td>
      <td>3</td>
      <td>14</td>
      <td>17</td>
      <td>24</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>663</td>
      <td>164</td>
      <td>43</td>
      <td>2016-06-12</td>
      <td>2016-06-12</td>
      <td>2016</td>
      <td>6</td>
      <td>12</td>
      <td>0</td>
      <td>43</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2124</td>
      <td>19</td>
      <td>695</td>
      <td>2016-01-19</td>
      <td>2016-01-19</td>
      <td>2016</td>
      <td>1</td>
      <td>19</td>
      <td>11</td>
      <td>35</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>429</td>
      <td>97</td>
      <td>1172</td>
      <td>2016-04-06</td>
      <td>2016-04-06</td>
      <td>2016</td>
      <td>4</td>
      <td>6</td>
      <td>19</td>
      <td>32</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>435</td>
      <td>86</td>
      <td>810</td>
      <td>2016-03-26</td>
      <td>2016-03-26</td>
      <td>2016</td>
      <td>3</td>
      <td>26</td>
      <td>13</td>
      <td>30</td>
      <td>False</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Number of trips in holiday: 49736
</code></pre></div></div>

<h2 id="32-traffic-features">3.2. Traffic Features</h2>

<p>A brief search on Google about New York City’s traffic patterns revealed useful insights from sources such as <a href="https://www.uber.com/blog/new-york-city/the-drivers-guide-to-traffic-in-a-new-york-minute/">A Guide to Traffic in NYC</a> and in <a href="https://intellishift.com/resources/blog/10-tips-to-beat-nyc-traffic/">10 Tips to Beat NYC Traffic</a> sites. These resources suggest that high traffic times in and out of Manhattan typically occur between 8-9 a.m. and 3-7 p.m. Based on this information, we will create a new feature called <code class="language-plaintext highlighter-rouge">is_rush_hour</code>  to determine whether the pickup time falls within rush hour on a given day. To simplify, weekends and holidays will be considered as having normal traffic hours throughout the day. Here based on this information and on the <a href="#5.-exploratory-data-analysis-(eda)">Exploratory Data Analysis</a> section, we chose to consider the following time intervals for rush hours: 7-10 a.m. and 4-8 p.m . This feature will be a binary feature that indicates a increase in traffic during the rush hours:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define rush hours
</span><span class="n">morning_rush</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">evening_rush</span> <span class="o">=</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># Weekdays are 0 (Monday) to 4 (Friday)
</span><span class="n">is_weekday</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span>


<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">is_rush_hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">morning_rush</span> <span class="o">|</span> <span class="n">evening_rush</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_weekday</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>1</td>
      <td>-73.982155</td>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>1</td>
      <td>-73.980415</td>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>1</td>
      <td>-73.979027</td>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_duration</th>
      <th>day_of_year</th>
      <th>pickup_date</th>
      <th>dropoff_date</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>minute</th>
      <th>is_holiday</th>
      <th>is_weekend</th>
      <th>is_rush_hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>455</td>
      <td>74</td>
      <td>2016-03-14</td>
      <td>2016-03-14</td>
      <td>2016</td>
      <td>3</td>
      <td>14</td>
      <td>17</td>
      <td>24</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>663</td>
      <td>164</td>
      <td>2016-06-12</td>
      <td>2016-06-12</td>
      <td>2016</td>
      <td>6</td>
      <td>12</td>
      <td>0</td>
      <td>43</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2124</td>
      <td>19</td>
      <td>2016-01-19</td>
      <td>2016-01-19</td>
      <td>2016</td>
      <td>1</td>
      <td>19</td>
      <td>11</td>
      <td>35</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="33-distance-features">3.3. Distance Features</h2>

<p>In an article on <a href="https://link.springer.com/article/10.1007/s13198-021-01130-x">New York City taxi trip duration prediction using MLP and XGBoost</a>, as discussed in the outliers section, some distance measures were discussed, like Manhattan, haversine, and bearing distances.</p>

<p>For this project, I will adopt a simplified approach that still accounts for the Earth’s curvature. This will involve calculating the geodesic distance using the geopy library and computing the bearing distance. The bearing distance measures the angle between the north line and the line connecting the pickup and dropoff locations.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Again lets use the function geodesic to create new features
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">geodesic</span><span class="p">(</span>  <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                            <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                            <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                            <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">())</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">bearing</span><span class="p">(</span><span class="n">start_lat</span><span class="p">,</span> <span class="n">start_lon</span><span class="p">,</span> <span class="n">end_lat</span><span class="p">,</span> <span class="n">end_lon</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Calculate the initial bearing (azimuth) between two sets of latitude and longitude coordinates.

    Args:
    - start_lat (float): Latitude of the starting point in degrees.
    - start_lon (float): Longitude of the starting point in degrees.
    - end_lat (float): Latitude of the ending point in degrees.
    - end_lon (float): Longitude of the ending point in degrees.

    Returns:
    float: The initial bearing in degrees, normalized to the range [0, 360).
    </span><span class="sh">"""</span>
    
    <span class="c1"># Convert latitude and longitude from degrees to radians
</span>    <span class="n">start_lat</span><span class="p">,</span> <span class="n">start_lon</span><span class="p">,</span> <span class="n">end_lat</span><span class="p">,</span> <span class="n">end_lon</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">start_lat</span><span class="p">,</span> <span class="n">start_lon</span><span class="p">,</span> <span class="n">end_lat</span><span class="p">,</span> <span class="n">end_lon</span><span class="p">])</span>

    <span class="c1"># Calculate the change in coordinates
</span>    <span class="n">dlon</span> <span class="o">=</span> <span class="n">end_lon</span> <span class="o">-</span> <span class="n">start_lon</span>

    <span class="c1"># Calculate bearing
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">dlon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">end_lat</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">start_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">end_lat</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">start_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">end_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">dlon</span><span class="p">)</span>
    <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arctan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Convert from radians to degrees and normalize (0-360)
</span>    <span class="n">initial_bearing</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">degrees</span><span class="p">(</span><span class="n">initial_bearing</span><span class="p">)</span>
    <span class="n">bearing</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_bearing</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>

    <span class="k">return</span> <span class="n">bearing</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create bearing feature
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">bearing</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">bearing</span><span class="p">(</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">],</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">],</span> 
                                <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">],</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">])</span>



<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>1</td>
      <td>-73.982155</td>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>1</td>
      <td>-73.980415</td>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>1</td>
      <td>-73.979027</td>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_duration</th>
      <th>day_of_year</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>minute</th>
      <th>is_holiday</th>
      <th>is_weekend</th>
      <th>is_rush_hour</th>
      <th>geodesic_distance</th>
      <th>bearing</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>455</td>
      <td>74</td>
      <td>2016</td>
      <td>3</td>
      <td>14</td>
      <td>17</td>
      <td>24</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>1502.171837</td>
      <td>99.970196</td>
    </tr>
    <tr>
      <th>1</th>
      <td>663</td>
      <td>164</td>
      <td>2016</td>
      <td>6</td>
      <td>12</td>
      <td>0</td>
      <td>43</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>1808.659969</td>
      <td>242.846232</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2124</td>
      <td>19</td>
      <td>2016</td>
      <td>1</td>
      <td>19</td>
      <td>11</td>
      <td>35</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>6379.687175</td>
      <td>200.319835</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="34-weather-features">3.4. Weather Features</h2>

<p>Even small weather changes, like rain or snow, can significantly affect traffic and transportation patterns in a large city. Rain or snow can impact driving conditions, increase traffic congestion, and influence public transportation usage, leading to longer taxi trip times and potentially higher demand for taxis. Therefore, we will use the
<a href="https://www.kaggle.com/datasets/cabaki/knycmetars2016">weather dataset from kaggle</a>. This dataset includes information on temperature, precipitation, visibility, and other relevant weather metrics. We plan to integrate this data with our taxi trip dataset by merging them based on date and time as we did before with the holidays dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weather</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/raw/nyc-weather-2016.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>Temp.</th>
      <th>Windchill</th>
      <th>Heat Index</th>
      <th>Humidity</th>
      <th>Pressure</th>
      <th>Dew Point</th>
      <th>Visibility</th>
      <th>Wind Dir</th>
      <th>Wind Speed</th>
      <th>Gust Speed</th>
      <th>Precip</th>
      <th>Events</th>
      <th>Conditions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2015-12-31 02:00:00</td>
      <td>7.8</td>
      <td>7.1</td>
      <td>NaN</td>
      <td>0.89</td>
      <td>1017.0</td>
      <td>6.1</td>
      <td>8.0</td>
      <td>NNE</td>
      <td>5.6</td>
      <td>0.0</td>
      <td>0.8</td>
      <td>NaN</td>
      <td>Overcast</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2015-12-31 03:00:00</td>
      <td>7.2</td>
      <td>5.9</td>
      <td>NaN</td>
      <td>0.90</td>
      <td>1016.5</td>
      <td>5.6</td>
      <td>12.9</td>
      <td>Variable</td>
      <td>7.4</td>
      <td>0.0</td>
      <td>0.3</td>
      <td>NaN</td>
      <td>Overcast</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2015-12-31 04:00:00</td>
      <td>7.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.90</td>
      <td>1016.7</td>
      <td>5.6</td>
      <td>12.9</td>
      <td>Calm</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>Overcast</td>
    </tr>
  </tbody>
</table>
</div>

<p>The weather dataset shows some missing values in features like <code class="language-plaintext highlighter-rouge">Windchill</code>, <code class="language-plaintext highlighter-rouge">Heat Index</code>, <code class="language-plaintext highlighter-rouge">Pressure</code>, and <code class="language-plaintext highlighter-rouge">Visibility</code>. For our analysis, <code class="language-plaintext highlighter-rouge">Visibility</code> is a critical feature due to its potential impact on driving conditions. The missing values in <code class="language-plaintext highlighter-rouge">Windchill</code> and <code class="language-plaintext highlighter-rouge">Heat Index</code> are not a concern for our study, as these factors are less directly related to traffic patterns. Other relevant features for our analysis, such as <code class="language-plaintext highlighter-rouge">Conditions</code> and <code class="language-plaintext highlighter-rouge">Temp.</code> have no missing values, and we do not need to worry.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Checking for missing values, data types and duplicates:
</span><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">duplicated values:</span><span class="sh">'</span><span class="p">,</span> <span class="n">weather</span><span class="p">.</span><span class="nf">duplicated</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">info</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">isnull</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span> 

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>duplicated values: 0


&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 8787 entries, 0 to 8786
Data columns (total 14 columns):
 #   Column      Non-Null Count  Dtype         
---  ------      --------------  -----         
 0   Time        8787 non-null   datetime64[ns]
 1   Temp.       8787 non-null   float64       
 2   Windchill   2295 non-null   float64       
 3   Heat Index  815 non-null    float64       
 4   Humidity    8787 non-null   float64       
 5   Pressure    8556 non-null   float64       
 6   Dew Point   8787 non-null   float64       
 7   Visibility  8550 non-null   float64       
 8   Wind Dir    8787 non-null   object        
 9   Wind Speed  8787 non-null   float64       
 10  Gust Speed  8787 non-null   float64       
 11  Precip      8787 non-null   float64       
 12  Events      455 non-null    object        
 13  Conditions  8787 non-null   object        
dtypes: datetime64[ns](1), float64(10), object(3)
memory usage: 961.2+ KB



None







Time             0
Temp.            0
Windchill     6492
Heat Index    7972
Humidity         0
Pressure       231
Dew Point        0
Visibility     237
Wind Dir         0
Wind Speed       0
Gust Speed       0
Precip           0
Events        8332
Conditions       0
dtype: int64
</code></pre></div></div>

<p>The feature <code class="language-plaintext highlighter-rouge">Conditions</code> is a categorical feature that describes the weather conditions at the time of the observation. the feature have the following unique values of categorical data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['Overcast' 'Clear' 'Partly Cloudy' 'Mostly Cloudy' 'Scattered Clouds'
 'Unknown' 'Light Rain' 'Haze' 'Rain' 'Heavy Rain' 'Light Snow' 'Snow'
 'Heavy Snow' 'Light Freezing Fog' 'Light Freezing Rain' 'Fog']
</code></pre></div></div>

<p>This features can be used to create new binary features that indicate the presence of a specific weather condition. We can create new features as <code class="language-plaintext highlighter-rouge">snow</code>, <code class="language-plaintext highlighter-rouge">heavy_snow</code>, <code class="language-plaintext highlighter-rouge">rain</code>, <code class="language-plaintext highlighter-rouge">heavy_rain</code> that indicates whether it was snowing or raining at the time of the observation. to create this features, we first group the <code class="language-plaintext highlighter-rouge">Conditions</code> feature into 4 categories:</p>

<ul>
  <li>
    <p>Snow: Light Snow, Snow</p>
  </li>
  <li>
    <p>Heavy Snow: Heavy Snow,Lightning freezing fog,  Fog</p>
  </li>
  <li>
    <p>Rain: Light Rain, Rain</p>
  </li>
  <li>
    <p>Heavy Rain: Heavy Rain, Light Freezing Rain</p>
  </li>
</ul>

<p>The idea to group the conditions this way is to consider the conditions that can impact the traffic in a similar way. For example, I add Fog in Heavy Snow because it can affect the visibility in a similar way. The same for Light Freezing Rain and Heavy Rain.</p>

<p>To integrate weather data into the dataset of taxi trip, we must first preprocessed the weather dataset to align it with the taxi trip dataset. Let’s separate the date and time into different columns for  <code class="language-plaintext highlighter-rouge">year</code>, <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">day</code>, <code class="language-plaintext highlighter-rouge">hour</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">year</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">day</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">hour</span>

<span class="c1"># Select only the year of 2016
</span><span class="n">weather</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2016</span><span class="p">)]</span>

<span class="c1"># Select only the months that have in the taxi dataset
</span><span class="n">months_taxi_trip</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">()</span>
<span class="n">select_month</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">months_taxi_trip</span><span class="p">)</span>
<span class="n">weather</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="n">select_month</span><span class="p">]</span>


<span class="c1"># Create new features based in the conditions column
</span><span class="n">snow</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Light Snow</span><span class="sh">'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Snow</span><span class="sh">'</span><span class="p">)</span>
<span class="n">heavy_snow</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Heavy Snow</span><span class="sh">'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Light Freezing Fog</span><span class="sh">'</span><span class="p">)</span>\
                                                    <span class="o">|</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Fog</span><span class="sh">'</span><span class="p">)</span>

<span class="n">rain</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Light Rain</span><span class="sh">'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Rain</span><span class="sh">'</span><span class="p">)</span>
<span class="n">heavy_rain</span> <span class="o">=</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Heavy Rain</span><span class="sh">'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Light Freezing Rain</span><span class="sh">'</span><span class="p">)</span> 

<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">snow</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">snow</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">heavy_snow</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_snow</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">rain</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">rain</span>
<span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">heavy_rain</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">heavy_rain</span>

<span class="c1"># Drop the features that are not needed
</span><span class="n">weather</span><span class="p">.</span><span class="nf">drop</span><span class="p">([</span> <span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Windchill</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Heat Index</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Humidity</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Pressure</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Dew Point</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Wind Dir</span><span class="sh">'</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">Wind Speed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Events</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Conditions</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Gust Speed</span><span class="sh">'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Rename columns to lowercase as in the taxi dataset
</span><span class="n">weather</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">Temp.</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">temperature</span><span class="sh">'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">weather</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">Visibility</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">weather</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">Precip</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">precipitation</span><span class="sh">'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temperature</th>
      <th>visibility</th>
      <th>precipitation</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
      <th>snow</th>
      <th>heavy_snow</th>
      <th>rain</th>
      <th>heavy_rain</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>22</th>
      <td>5.6</td>
      <td>16.1</td>
      <td>0.0</td>
      <td>2016</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>23</th>
      <td>5.6</td>
      <td>16.1</td>
      <td>0.0</td>
      <td>2016</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>24</th>
      <td>5.6</td>
      <td>16.1</td>
      <td>0.0</td>
      <td>2016</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can check the maximum and minimum values for each feature to see if there is any inconsistency. As shown below, all features appear to be consistent with the range of values expected for each feature.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># max and min values
</span><span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">describe</span><span class="p">().</span><span class="n">loc</span><span class="p">[[</span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">]])</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temperature</th>
      <th>visibility</th>
      <th>precipitation</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>min</th>
      <td>-18.3</td>
      <td>0.4</td>
      <td>0.0</td>
      <td>2016.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>max</th>
      <td>32.2</td>
      <td>16.1</td>
      <td>11.9</td>
      <td>2016.0</td>
      <td>6.0</td>
      <td>31.0</td>
      <td>23.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>Missing values</strong></p>

<p>We need to handle the missing values in visibility. This feature has values approximately between 0-16, where 0 indicates the worse visibility and 16 the best visibility.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Unique values for visibility:</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">weather</span><span class="p">.</span><span class="nf">isna</span><span class="p">().</span><span class="nf">sum</span><span class="p">().</span><span class="nf">head</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Unique values for visibility:
 [16.1  nan 14.5  8.  12.9 11.3  6.4  4.8  2.4  2.8  2.   4.   3.2  9.7
  1.2  0.8  1.6  0.4]





temperature        0
visibility       132
precipitation      0
year               0
month              0
dtype: int64
</code></pre></div></div>

<p>To better understand the nature of the missing values, let’s create a table that correlates these missing values with different weather conditions. The missing values do not appear randomly distributed, they occur when the weather condition is good. To visualize this we can create a table that shows the number of <code class="language-plaintext highlighter-rouge">NaN</code> values in visibility named <code class="language-plaintext highlighter-rouge">is_visibility_nan</code> by the total number of days snowing and raining :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">is_visibility_nan</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">].</span><span class="nf">isna</span><span class="p">()</span>

<span class="n">weather_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span>
    <span class="sh">'</span><span class="s">is_visibility_nan</span><span class="sh">'</span><span class="p">:</span> <span class="n">is_visibility_nan</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">#snowing_days</span><span class="sh">'</span><span class="p">:</span> <span class="n">snow</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">#heavy_snowing_days</span><span class="sh">'</span><span class="p">:</span> <span class="n">heavy_snow</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">#raining_days</span><span class="sh">'</span><span class="p">:</span> <span class="n">rain</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">#heavy_raining_days</span><span class="sh">'</span><span class="p">:</span> <span class="n">heavy_rain</span><span class="p">})</span>

<span class="c1"># Group by 'Visibility NaN' and calculate the sum for each weather condition
</span><span class="n">summary</span> <span class="o">=</span> <span class="n">weather_summary</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">is_visibility_nan</span><span class="sh">'</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>

<span class="n">summary</span><span class="p">[</span><span class="sh">'</span><span class="s">total_counts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">is_visibility_nan</span><span class="p">.</span><span class="nf">value_counts</span><span class="p">().</span><span class="n">values</span>

<span class="c1"># Reset index to turn 'Visibility NaN' back into a column
</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>


<span class="nf">display</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>is_visibility_nan</th>
      <th>#snowing_days</th>
      <th>#heavy_snowing_days</th>
      <th>#raining_days</th>
      <th>#heavy_raining_days</th>
      <th>total_counts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>61</td>
      <td>6</td>
      <td>171</td>
      <td>10</td>
      <td>4200</td>
    </tr>
    <tr>
      <th>1</th>
      <td>True</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>132</td>
    </tr>
  </tbody>
</table>
</div>

<p>When <code class="language-plaintext highlighter-rouge">is_visibility_nan</code> is <code class="language-plaintext highlighter-rouge">True</code> (visibility data is missing), there are 132 days in total, and notably, none of these days are recorded as having snowing, heavy snowing, raining, or heavy raining conditions. This absence of precipitation-related weather conditions on days with missing visibility data suggests that visibility tends to be unrecorded primarily on days with good or clear weather.</p>

<p>This could make sense, as maybe under clear conditions, they overlook recording some values. Therefore, we can logically fill the missing values with the maximum value of visibility.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">].</span><span class="nf">max</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Missing values in visibility: </span><span class="sh">"</span><span class="p">,</span><span class="n">weather</span><span class="p">[</span><span class="sh">'</span><span class="s">visibility</span><span class="sh">'</span><span class="p">].</span><span class="nf">isna</span><span class="p">().</span><span class="nf">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Missing values in visibility:  0
</code></pre></div></div>

<p>We will use the combination of <code class="language-plaintext highlighter-rouge">year</code>, <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">day</code>, <code class="language-plaintext highlighter-rouge">hour</code> features to merge the taxi trip dataset with the weather dataset using a left join:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip_merge</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">weather</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">day</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip_merge</span><span class="p">.</span><span class="nf">isna</span><span class="p">().</span><span class="nf">sum</span><span class="p">().</span><span class="nf">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Save the weather dataset
</span><span class="n">weather</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/external/nyc-weather-2016.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>is_rush_hour             0
geodesic_distance        0
bearing                  0
temperature          11751
visibility           11751
precipitation        11751
snow                 11751
heavy_snow           11751
rain                 11751
heavy_rain           11751
dtype: int64
</code></pre></div></div>

<p>After merging the two datasets, we can see that there are some missing dates in the weather dataset, causing 11751 missing values for the weather features. This is less then 1% of our entire dataset, so we can take a more simplified approach by dropping these rows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">taxi_trip_merge</span><span class="p">.</span><span class="nf">dropna</span><span class="p">().</span><span class="nf">copy</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Old size:</span><span class="sh">'</span><span class="p">,</span><span class="n">taxi_trip_merge</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">New size:</span><span class="sh">'</span><span class="p">,</span><span class="n">taxi_trip</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nf">display</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Old size: 1427156

New size: 1415405
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<!-- First part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>vendor_id</th>
      <th>passenger_count</th>
      <th>pickup_longitude</th>
      <th>pickup_latitude</th>
      <th>dropoff_longitude</th>
      <th>dropoff_latitude</th>
      <th>store_and_fwd_flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id2875421</td>
      <td>2</td>
      <td>1</td>
      <td>-73.982155</td>
      <td>40.767937</td>
      <td>-73.964630</td>
      <td>40.765602</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id2377394</td>
      <td>1</td>
      <td>1</td>
      <td>-73.980415</td>
      <td>40.738564</td>
      <td>-73.999481</td>
      <td>40.731152</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id3858529</td>
      <td>2</td>
      <td>1</td>
      <td>-73.979027</td>
      <td>40.763939</td>
      <td>-74.005333</td>
      <td>40.710087</td>
      <td>False</td>
    </tr>
  </tbody>
</table>

<!-- Second part of the table -->
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_duration</th>
      <th>day_of_year</th>
      <th>is_rush_hour</th>
      <th>geodesic_distance</th>
      <th>bearing</th>
      <th>temperature</th>
      <th>visibility</th>
      <th>precipitation</th>
      <th>snow</th>
      <th>heavy_snow</th>
      <th>rain</th>
      <th>heavy_rain</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>455</td>
      <td>74</td>
      <td>True</td>
      <td>1502.171837</td>
      <td>99.970196</td>
      <td>4.4</td>
      <td>8.0</td>
      <td>0.3</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>663</td>
      <td>164</td>
      <td>False</td>
      <td>1808.659969</td>
      <td>242.846232</td>
      <td>28.9</td>
      <td>16.1</td>
      <td>0.0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2124</td>
      <td>19</td>
      <td>False</td>
      <td>6379.687175</td>
      <td>200.319835</td>
      <td>-6.7</td>
      <td>16.1</td>
      <td>0.0</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="35-cluster-features">3.5 Cluster Features</h2>

<p>Here we will use the mini-batch k-means algorithm to cluster the pickup and dropoff locations into 100 clusters. We will then use the cluster centers to create new features that represent the distance between the pickup and dropoff locations and the cluster centers. This can help the model to identify patterns in the data related to the cluster centers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_clusters_map</span><span class="p">(</span>  <span class="n">df</span><span class="p">,</span> <span class="n">gdf_map</span><span class="p">,</span> <span class="n">latitude_col</span><span class="p">,</span> <span class="n">longitude_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span> <span class="sh">'</span><span class="s">beige</span><span class="sh">'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span> <span class="sh">'</span><span class="s">grey</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">tab20</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    
    <span class="sh">"""</span><span class="s">
    Plots a geographical map with clusters from a DataFrame.

    Parameters:
    - df: DataFrame containing the data to be plotted.
    - gdf_map: GeoDataFrame representing the geographical boundaries.
    - latitude_col: Name of the column containing latitude data.
    - longitude_col: Name of the column containing longitude data.
    - cluster_col: Name of the column containing cluster identifiers.
    - ax: Matplotlib Axes object for plotting.
    - title: Title of the plot.
    - sample_size: Number of data points to sample from df (0 for all).
    - color_map: Color for the map.
    - edgecolor: Edge color for the map.
    - random_state: Random state for reproducibility in sampling.
    - cmap: Colormap for clusters.
    - alpha: Transparency level for cluster points.
    </span><span class="sh">"""</span>
    
    
    <span class="k">if</span> <span class="n">sample_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        
    <span class="c1"># Create geometry and GeoDataFrame
</span>    <span class="n">geometry</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">points_from_xy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">longitude_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">latitude_col</span><span class="p">])</span>
    <span class="n">gdf_clusters</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">).</span><span class="nf">set_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
    
    <span class="c1"># Convert map to the same CRS
</span>    <span class="n">gdf_map</span> <span class="o">=</span> <span class="n">gdf_map</span><span class="p">.</span><span class="nf">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
    <span class="n">gdf_map</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">)</span>  <span class="c1"># Plot the NYC boundary
</span>    
    <span class="c1"># Scatter plot for clusters
</span>    <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span> <span class="n">gdf_clusters</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdf_clusters</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                <span class="n">c</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">].</span><span class="n">values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>  <span class="c1"># Plot clusters
</span>    
    <span class="c1"># Set labels and title
</span>    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s create more six features based in the results of the mini-batch k-means algorithm. We will create two features for the predict clusters, one for pickup and one for dropoff locations. From this features we extract the longitude and latitude centers of each cluster, creating four features: <code class="language-plaintext highlighter-rouge">pickup_center_lat</code>, <code class="language-plaintext highlighter-rouge">pickup_center_long</code>, <code class="language-plaintext highlighter-rouge">dropoff_center_lat</code>, <code class="language-plaintext highlighter-rouge">dropoff_center_long</code>. We will also create two features for the distance between the pickup and dropoff cluster centers, <code class="language-plaintext highlighter-rouge">pickup_cluster_distance</code> and <code class="language-plaintext highlighter-rouge">dropoff_cluster_distance</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pickup_locations</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">]]</span>
<span class="n">dropoff_locations</span> <span class="o">=</span> <span class="n">taxi_trip</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">]]</span>


<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">vstack</span><span class="p">(</span> <span class="p">[</span><span class="n">pickup_locations</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dropoff_locations</span><span class="p">.</span><span class="n">values</span><span class="p">])</span>

<span class="c1"># Randomly permute the combined coordinates 
</span><span class="n">sample_coords</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">permutation</span><span class="p">(</span><span class="n">coords</span><span class="p">)[:</span><span class="mi">500000</span><span class="p">]</span>


<span class="n">kmeans_coords</span> <span class="o">=</span> <span class="nc">MiniBatchKMeans</span><span class="p">(</span>    <span class="n">n_clusters</span><span class="o">=</span> <span class="mi">100</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
                                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_init</span> <span class="o">=</span> <span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">)</span>

<span class="n">kmeans_coords</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">sample_coords</span><span class="p">)</span>


<span class="c1"># Predict clusters for the full dataset
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans_coords</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">pickup_locations</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans_coords</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">dropoff_locations</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">cluster_centers</span> <span class="o">=</span> <span class="n">kmeans_coords</span><span class="p">.</span><span class="n">cluster_centers_</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_center_lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_center_lon</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_center_lat</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_center_lon</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_centers</span><span class="p">[</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Calculate the geodesic distance
</span><span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">center_geodesic_distances</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">geodesic</span><span class="p">(</span>  <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_center_lat</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                                    <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">pickup_center_lon</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                                    <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_center_lat</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">(),</span> 
                                                    <span class="n">taxi_trip</span><span class="p">[</span><span class="sh">'</span><span class="s">dropoff_center_lon</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">())</span>

<span class="n">taxi_trip</span><span class="p">[[</span><span class="sh">'</span><span class="s">center_geodesic_distances</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]].</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>center_geodesic_distances</th>
      <th>geodesic_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1381.650448</td>
      <td>1502.171837</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1909.482823</td>
      <td>1808.659969</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6462.250705</td>
      <td>6379.687175</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1864.313219</td>
      <td>1483.632481</td>
    </tr>
    <tr>
      <th>4</th>
      <td>844.527437</td>
      <td>1187.037659</td>
    </tr>
  </tbody>
</table>
</div>

<p>For a visualization, we can plot the clusters using the shape file from <a href="https://data.cityofnewyork.us/City-Government/Borough-Boundaries/tqmj-j8zm">NYC Borough Boundaries</a> and the cluster centers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Pickup Locations</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Dropoff Locations</span><span class="sh">'</span><span class="p">]</span>
<span class="c1"># Column names 
</span><span class="n">location_columns</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">),</span> 
                    <span class="p">(</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Loop through each subplot
</span><span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="p">(</span><span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">titles</span><span class="p">,</span> <span class="n">location_columns</span><span class="p">):</span>
    <span class="nf">plot_clusters_map</span><span class="p">(</span>  <span class="n">taxi_trip</span><span class="p">,</span> <span class="n">nyc_boundary</span><span class="p">,</span> <span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span> <span class="n">beige</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">)</span>
    
    <span class="c1"># Plot the cluster centers
</span>    <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span> <span class="n">cluster_centers</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cluster_centers</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                <span class="n">c</span> <span class="o">=</span> <span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
    
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/cluster_map_dropoff_pickup.png" width="800" height="500" />
</center>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Save the dataset
</span><span class="n">taxi_trip</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/interim/nyc-taxi-trip-2016-new-features.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="4-split-dataset"><strong>4. Split Dataset</strong></h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_trip</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/interim/nyc-taxi-trip-2016-new-features.csv</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="n">parse_dates</span><span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">dropoff_date</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p>Let’s choose to split the dataset first into two parts, <code class="language-plaintext highlighter-rouge">df_train_large</code> and <code class="language-plaintext highlighter-rouge">df_test</code>. The <code class="language-plaintext highlighter-rouge">df_train_large</code> will be used for exploratory data analysis (EDA) to understand the dataset deeply and identify key features. Then, using the <code class="language-plaintext highlighter-rouge">df_train_large</code> dataset, we will split it again into <code class="language-plaintext highlighter-rouge">df_train</code> and <code class="language-plaintext highlighter-rouge">df_val</code>. The <code class="language-plaintext highlighter-rouge">df_train</code> will be used to train our machine learning models and validate their prediction with the <code class="language-plaintext highlighter-rouge">df_val</code> dataset. The <code class="language-plaintext highlighter-rouge">df_test</code> set, is reserved until the end, and will provide an unbiased assessment of the model’s performance on unseen data, preventing any kind of data leakage. Also, we will use the <code class="language-plaintext highlighter-rouge">df_train_large</code> to compare the performance with the <code class="language-plaintext highlighter-rouge">df_test</code> set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Split in 35.75% Train /29.25% Validation/ 35% Test
</span><span class="n">df_train_large</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.40</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span><span class="p">)</span>
<span class="n">df_train</span><span class="p">,</span> <span class="n">df_val</span> <span class="o">=</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">,</span> <span class="n">train_size</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Train large:</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">)</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">)</span><span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Test: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Train:</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Validation: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">df_val</span><span class="p">)</span><span class="si">}</span><span class="s">(</span><span class="si">{</span><span class="nf">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nf">len</span><span class="p">(</span><span class="n">df_val</span><span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">taxi_trip</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s">%)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Train large:849243(60.0%)
Test: 566162(40.0%)
Train:467083(33.0%)
Validation: 382160(27.0%)
</code></pre></div></div>

<p>Also, to visualize the split data and check if the spatial and temporal features are representative in each dataset, we plot the NYC map for the pickup and dropoff locations clusters and the counts of pickup by the dates. We can see that the split is representative for the spatial and temporal features:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nybb_path</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../data/external/nyc-borough-boundaries/geo_export_e13eede4-6de2-4ed8-98a0-58290fd6b0fa.shp</span><span class="sh">'</span>
<span class="n">nyc_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="n">nybb_path</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">.</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># Flatten the axes array for easy iteration
</span>
<span class="c1"># Titles and Column names
</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Pickup Cluster Locations</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Dropoff Cluster Locations</span><span class="sh">'</span><span class="p">]</span>
<span class="c1"># Column names 
</span><span class="n">location_columns</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">),</span> 
                    <span class="p">(</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">)]</span>

<span class="c1"># Loop for training data
</span><span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="p">(</span><span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">titles</span><span class="p">,</span> <span class="n">location_columns</span><span class="p">):</span>
    <span class="nf">plot_clusters_map</span><span class="p">(</span>  <span class="n">df_train</span><span class="p">,</span> <span class="n">nyc_boundary</span><span class="p">,</span> <span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="n">title</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> (Train)</span><span class="sh">'</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span> <span class="n">beige</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">)</span>

<span class="c1"># Loop for test data
</span><span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="p">(</span><span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">titles</span><span class="p">,</span> <span class="n">location_columns</span><span class="p">):</span>
    <span class="nf">plot_clusters_map</span><span class="p">(</span>  <span class="n">df_test</span><span class="p">,</span> <span class="n">nyc_boundary</span><span class="p">,</span> <span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="n">title</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> (Test)</span><span class="sh">'</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span> <span class="n">beige</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/cluster_map_dropoff_pickup_train_test.png" width="800" height="700" />
</center>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">df_train</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">)[[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]].</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">]),</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span> <span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Train</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">yellow</span><span class="p">)</span>
<span class="n">axes</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">df_test</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">)[[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]].</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">]),</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Test</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">orange</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Pickup records per day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span><span class="sh">'</span><span class="s">lower right</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of records</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/time_series_trip.png" width="800" height="300" />
</center>

<h1 id="5-exploratory-data-analysis-eda"><strong>5. Exploratory Data Analysis (EDA)</strong></h1>

<p>We proceed with the EDA in the <code class="language-plaintext highlighter-rouge">df_train_large</code> dataset, which is the combination of both training and validation sets. To prevent data leakage, we don’t include the test set for the EDA. This will ensure the trained model evaluation on the test set is unbiased, without information from the train set mistakenly leakage to the test.</p>

<h2 id="51-feature-visualizations">5.1 Feature Visualizations</h2>

<p>Let’s first plot one more time the maps of NYC pickup and dropoff cluster locations. We can see that for both the clusters are concentrated in Manhattan. The main difference between pickup and dropoff locations is the concentration of the clusters outside Manhattan. For dropoff locations, are also more concentration in other regions like in Brooklyn and Queens, when compared to the pickup locations. This is expected because Manhattan is a commercial and financial center of the United States, and Brooklyn and Queens are residential boroughs.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nybb_path</span> <span class="o">=</span> <span class="sh">'</span><span class="s">../data/external/nyc-borough-boundaries/geo_export_e13eede4-6de2-4ed8-98a0-58290fd6b0fa.shp</span><span class="sh">'</span>
<span class="n">nyc_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nf">read_file</span><span class="p">(</span><span class="n">nybb_path</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">.</span><span class="nf">flatten</span><span class="p">()</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Pickup Cluster Locations</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Dropoff Cluster Locations</span><span class="sh">'</span><span class="p">]</span>
<span class="n">location_columns</span> <span class="o">=</span> <span class="p">[(</span><span class="sh">'</span><span class="s">pickup_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_cluster</span><span class="sh">'</span><span class="p">),</span> 
                    <span class="p">(</span><span class="sh">'</span><span class="s">dropoff_latitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_longitude</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_cluster</span><span class="sh">'</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="p">(</span><span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">titles</span><span class="p">,</span> <span class="n">location_columns</span><span class="p">):</span>
    <span class="nf">plot_clusters_map</span><span class="p">(</span>  <span class="n">df_train_large</span><span class="p">,</span> <span class="n">nyc_boundary</span><span class="p">,</span> <span class="n">lat_col</span><span class="p">,</span> <span class="n">lon_col</span><span class="p">,</span> <span class="n">cluster_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">color_map</span> <span class="o">=</span> <span class="n">beige</span> <span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">)</span>
    
    <span class="c1"># iterrows: Loop through each row in the DataFrame.
</span>    <span class="c1"># return index of each row
</span>    <span class="c1"># return each row as pandas series
</span>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">nyc_boundary</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">():</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">geometry</span><span class="sh">'</span><span class="p">].</span><span class="n">centroid</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="n">centroid</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">centroid</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="sh">'</span><span class="s">boro_name</span><span class="sh">'</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">right</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">center</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/cluster_map_dropoff_pickup_boroughs.png" width="800" height="500" />
</center>

<p>Let’s look at a simple overview visualization of the pickup and dropoff latitudes and longitudes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># 2x2 grid for subplots
</span>
<span class="c1"># Pickup Longitude Histogram
</span><span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>   <span class="n">df_train_large</span><span class="p">.</span><span class="n">pickup_longitude</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Pickup Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Pickup Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Pickup Latitude Histogram
</span><span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span> <span class="n">df_train_large</span><span class="p">.</span><span class="n">pickup_latitude</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Pickup Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Pickup Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Dropoff Longitude Histogram
</span><span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>  <span class="n">df_train_large</span><span class="p">.</span><span class="n">dropoff_longitude</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Dropoff Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Dropoff Longitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Dropoff Latitude Histogram
</span><span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>   <span class="n">df_train_large</span><span class="p">.</span><span class="n">dropoff_latitude</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Dropoff Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Dropoff Latitude</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div>

<center>
<img src="/assets/img/post5/pickupt_dropoff_distribution.png" width="800" height="500" />
</center>

<p>For the bearing feature created in the <a href="##3.-feature-engineering"><strong>3. Feature Engineering</strong></a> section, we visualized the bearing feature’s distribution using a histogram in polar coordinates. The radial variable is the geodesic distance in log scale and the polar variable is the bearing angles in degrees. On the left we plot the histogram for the <code class="language-plaintext highlighter-rouge">bearing</code> in cartesian coordinates, and On the right we plot the histogram in polar coordinates.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Add a regular subplot for the linear histogram of bearing
</span><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>  <span class="c1"># 1 row, 2 columns, first subplot
</span><span class="n">sns</span><span class="p">.</span><span class="nf">histplot</span><span class="p">(</span>   <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">bearing</span><span class="sh">'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">lw</span><span class="sh">'</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Bearing Histogram</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Bearing (Degrees)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Add a polar subplot for the 2D histogram
</span><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="sh">'</span><span class="s">polar</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 1 row, 2 columns, second subplot with polar projection
</span>
<span class="c1"># Convert bearing to radians
</span><span class="n">bearing_rad</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">bearing</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># Create a 2D histogram in polar coordinates
</span><span class="n">hist</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">.</span><span class="nf">hist2d</span><span class="p">(</span>  <span class="n">bearing_rad</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="p">.</span><span class="nf">log10</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">]),</span> 
                                        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> 
                                        <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">YlOrBr</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Customize the polar plot
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_theta_zero_location</span><span class="p">(</span><span class="sh">'</span><span class="s">N</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># Set 0 degrees to the south
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Clockwise
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Bearing (Degrees)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Log10 of Geodesic Distance (m)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Add a color bar to represent counts on the polar plot
</span><span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.035</span><span class="p">)</span>
<span class="n">cbar</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Counts</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/bearing_distribution.png" width="800" height="400" />
</center>

<p>We can draw the following observations from these two plots:</p>

<ul>
  <li>
    <p>There are two peaks for the bearing direction around 22 and 200 degrees for geodesic distances between 1 and 10 kilometers. We could infer that these are bearing directions pointing towards Manhattan.</p>
  </li>
  <li>
    <p>There are other three lower peaks around 125, 300 and 350 degrees.</p>
  </li>
</ul>

<p>It appears that the bearing feature has some capability to distinguish the direction of the trip. This indicates potential importance of the <code class="language-plaintext highlighter-rouge">bearing</code> feature for the model. Also, it is important to note that the distance is on a logarithmic scale, emphasizing shorter trips.</p>

<p>For the categorical features <code class="language-plaintext highlighter-rouge">vendor_id</code>, <code class="language-plaintext highlighter-rouge">passanger_count</code> and <code class="language-plaintext highlighter-rouge">store_and_fwd_flag</code> we can use bar plots to visualize the distribution. Here the <code class="language-plaintext highlighter-rouge">vendor_id</code> refers to the companies that provide the taxi services, and the <code class="language-plaintext highlighter-rouge">store_and_fwd_flag</code> indicates whether the trip record was stored in vehicle memory before sending to the vendor.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># 3 rows, 1 column
</span>
<span class="c1"># Plot for vendor_id
</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">()</span>
<span class="n">vendor_id</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">yellow</span><span class="p">,</span> <span class="n">orange</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Company that Provides the Taxi Service</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot for store_and_fwd_flag
</span><span class="n">store_fwd_flag</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">store_and_fwd_flag</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">()</span>
<span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">store_fwd_flag</span><span class="p">).</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">yellow</span><span class="p">,</span> <span class="n">orange</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Trip Data Stored in Vehicle Memory (?)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">store_and_fwd_flag</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency (log scale)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plot for passenger_counts
</span><span class="n">passenger_counts</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">().</span><span class="nf">sort_index</span><span class="p">()</span>
<span class="n">passenger_counts</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">orange</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of Passengers</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">passenger_count</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Frequency</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/categorical_feature_distribution.png" width="900" height="300" />
</center>

<p>We can state the following observations:</p>

<ul>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">vendor_id</code> 2 has more trips than the <code class="language-plaintext highlighter-rouge">vendor_id</code> 1. This can be explained by the fact that the <code class="language-plaintext highlighter-rouge">vendor_id</code> 2 has more vehicles than the <code class="language-plaintext highlighter-rouge">vendor_id</code> 1.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">store_and_fwd_flag</code> is <code class="language-plaintext highlighter-rouge">False</code> for the majority of the trips (Note the use of log scale in the y-axis). This means that the majority of the trips are sent to the vendor immediately after the trip is completed. This could mean a lower chance of data loss.</p>
  </li>
  <li>
    <p>The majority of the trips have only one passenger.</p>
  </li>
</ul>

<p>For insight about temporal feature, like <code class="language-plaintext highlighter-rouge">day_of_week</code> and <code class="language-plaintext highlighter-rouge">hour_of_day</code>, we can plot those feature for each <code class="language-plaintext highlighter-rouge">vendor_id</code>. Let’s compare the taxi services of each company for the pickup location by the day of the week and hours of the day.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot for day_of_week
</span><span class="n">grouped_data_day</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">grouped_data_day</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">,</span> 
                <span class="n">hue</span><span class="o">=</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">yellow</span><span class="sh">'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xticklabels</span><span class="p">([</span><span class="sh">'</span><span class="s">Monday</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Tuesday</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Wednesday</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="sh">'</span><span class="s">Thursday</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Friday</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Saturday</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Sunday</span><span class="sh">'</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of Pickups by Day of the Week</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Total Number of Pickups</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Highlight weekdays for rush hour
</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>

<span class="c1"># Plot for hour_of_day
</span><span class="n">grouped_data_hour</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hour_of_day</span><span class="sh">'</span><span class="p">])[</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">].</span><span class="nf">count</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">grouped_data_hour</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">hour_of_day</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">,</span>  
                <span class="n">hue</span><span class="o">=</span><span class="sh">'</span><span class="s">vendor_id</span><span class="sh">'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">orange</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">yellow</span><span class="sh">'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Number of Pickups by Hour of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Hour of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Total Number of Pickups</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Highlight rush hour times
</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>

<span class="c1"># Adjust the legend for both subplots
</span><span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Vendor ID</span><span class="sh">'</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper left</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/time_series_pattern.png" width="900" height="300" />
</center>

<p>We can state the following observations based on the scatter plots:</p>

<ul>
  <li>
    <p>There is lower number of trips on monday and sunday for both vendors, if vendor 2 having more trips than vendor 1. The higher number of trips is on thursday and friday.</p>
  </li>
  <li>
    <p>For hours of the day, we can see that the vendor 2 has a closer number of trips than vendor 1.</p>
  </li>
  <li>
    <p>We add a grey region in the second plot to indicate the rush hours feature <code class="language-plaintext highlighter-rouge">is_rush_hour</code>, showing a well defined pattern of increase trips for both vendors between 7-10 a.m. and 4-8 p.m.</p>
  </li>
  <li>
    <p>There is a strong dip during the early morning hours. Here there is not much difference between the two vendors. Another dip occur around 4pm and then the numbers increase towards the evening.</p>
  </li>
</ul>

<p>For further insight about temporal features, we can count the trips for the hours of the day and plot the curves for months and days of the week.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_month</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]).</span><span class="nf">size</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">)</span>
<span class="n">grouped_weekday</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">]).</span><span class="nf">size</span><span class="p">().</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Define palettes
</span><span class="n">palette_month</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">tab20</span><span class="sh">"</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">palette_weekday</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">(</span><span class="sh">"</span><span class="s">tab20</span><span class="sh">"</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Month plot
</span><span class="n">sns</span><span class="p">.</span><span class="nf">lineplot</span><span class="p">(</span>   <span class="n">data</span><span class="o">=</span><span class="n">grouped_month</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">,</span>
                <span class="n">palette</span><span class="o">=</span><span class="n">palette_month</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Update the month legend
</span><span class="n">month_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Jan</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Feb</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Mar</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Apr</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">May</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Jun</span><span class="sh">'</span><span class="p">]</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Month</span><span class="sh">'</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">month_labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper left</span><span class="sh">'</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Hour of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Hour of Day vs Count by Month</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>

<span class="c1"># Weekday plot
</span><span class="n">sns</span><span class="p">.</span><span class="nf">lineplot</span><span class="p">(</span>   <span class="n">data</span><span class="o">=</span><span class="n">grouped_weekday</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">hour</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="sh">'</span><span class="s">day_of_week</span><span class="sh">'</span><span class="p">,</span> 
                <span class="n">palette</span><span class="o">=</span><span class="n">palette_weekday</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Update the weekday legend
</span><span class="n">weekday_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Mon</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Tue</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Wed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Thu</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Fri</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Sat</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Sun</span><span class="sh">'</span><span class="p">]</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Day of the Week</span><span class="sh">'</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">weekday_labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">lower right</span><span class="sh">'</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Hour of the Day</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Count</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Hour of Day vs Count by Weekday</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Highlight rush hour times
</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axvspan</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/time_series_hour_day_week.png" width="900" height="300" />
</center>

<p>We can state the following observations based on the line plots:</p>

<ul>
  <li>
    <p>For the months they show similar patterns as before for the hours of the day. Again respecting the rush hours feature <code class="language-plaintext highlighter-rouge">is_rush_hour</code>, showing a well defined pattern of increased trips between 7-10 a.m. and 4-8 p.m.</p>
  </li>
  <li>
    <p>January and June experience fewer trips, while March and April see a greater number of trips.</p>
  </li>
  <li>
    <p>In the <a href="#3.-feature-engineering">Feature Engineering</a> section, we excluded Saturdays and Sundays from the <code class="language-plaintext highlighter-rouge">is_rush_hour</code> definition. This choice is supported by the lines for Saturday and Sunday, which show significantly fewer trips than the other days of the week during the morning rush hours of 7-10 AM. However, during the evening rush hours of 4-8 PM, an interesting pattern occurs: Friday and Saturday see an increase in trips that extends into late night. This can be explained by the fact that Friday and Saturday are the days of the week with more nightlife activity in NYC.</p>
  </li>
</ul>

<h2 id="52-feature-correlations">5.2 Feature Correlations</h2>

<p>In the previous section, we visualized the distribution of some individual features to understand and get insights about the data. Now, we will look at the correlation between those features and the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> and the correlation between each other.</p>

<p>On the left, we plot a hexbin for the correlation between the log <code class="language-plaintext highlighter-rouge">trip_duration</code> and the log <code class="language-plaintext highlighter-rouge">geodesic_distance</code>, and in the right again we plot a 2d histogram in polar coordinates, where the radial is the log of the <code class="language-plaintext highlighter-rouge">trip_duration</code> and the polar angle is the log of the <code class="language-plaintext highlighter-rouge">bearing</code> feature. We can state the following observations:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">log_geodesic_distance</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">geodesic_distance</span><span class="sh">'</span><span class="p">])</span>
<span class="n">log_trip_duration</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">])</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>  
<span class="n">ax1</span><span class="p">.</span><span class="nf">hexbin</span><span class="p">(</span><span class="n">log_geodesic_distance</span><span class="p">,</span> <span class="n">log_trip_duration</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">YlOrBr</span><span class="sh">'</span><span class="p">,</span> <span class="n">mincnt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Log10 of Geodesic Distance (m)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Log1p of Trip Duration (s)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># Add a color bar to represent counts on the polar plot
</span><span class="n">cbar_hexbin</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.035</span><span class="p">)</span>
<span class="n">cbar_hexbin</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Counts</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Add a polar subplot for the 2D histogram
</span><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="sh">'</span><span class="s">polar</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># 1 row, 2 columns, second subplot with polar projection
</span><span class="n">bearing_rad</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">radians</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">bearing</span><span class="sh">'</span><span class="p">])</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">.</span><span class="nf">hist2d</span><span class="p">(</span>  <span class="n">bearing_rad</span><span class="p">,</span> 
                                        <span class="n">log_trip_duration</span><span class="p">,</span> 
                                        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> 
                                        <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">YlOrBr</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Customize the polar plot
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_theta_zero_location</span><span class="p">(</span><span class="sh">'</span><span class="s">N</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># Set 0 degrees to the south
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Clockwise
</span><span class="n">ax2</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Bearing (Degrees)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Log1p of Trip Duration (s)</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># Add a color bar to represent counts on the polar plot
</span><span class="n">cbar_polar</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.035</span><span class="p">)</span>
<span class="n">cbar_polar</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Counts</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/bearing_direction_corr.png" width="800" height="400" />
</center>

<p>By the left plot, we can see that there is a positive correlation between the log of the <code class="language-plaintext highlighter-rouge">trip_duration</code> and the log of the <code class="language-plaintext highlighter-rouge">geodesic_distance</code>. This is expected because the longer the distance, the longer the trip duration. However, this correlation is not linear, as we can see that the correlation is stronger for shorter distances. This can be explained by the fact that the longer the distance, the more traffic and other factors can influence the trip duration.</p>

<p>In the polar plot, there are two peaks for the bearing direction around 22 and 200 degrees for trip duration approximated between 405 and 1098 seconds,  which implies that most trips are short in this directions, probably covering distances between 1 and 10 kilometers as we previously stated.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Feature Importance</span><span class="sh">'</span><span class="p">,</span> 
                            <span class="n">xlabel</span><span class="o">=</span><span class="sh">'</span><span class="s">Features</span><span class="sh">'</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">'</span><span class="s">Importance</span><span class="sh">'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Function to plot the feature importance with a distinction of importance based on a threshold.

    Parameters:
    - df: pandas.DataFrame
        DataFrame containing features and their importance scores.
    - x: str
        Name of the column representing feature names.
    - y: str
        Name of the column representing feature importance scores.
    - ax: matplotlib axis object
        Axis on which to draw the plot.
    - threshold: float, optional (default=0.002)
        Value above which bars will be colored differently.
    - pad: float, optional (default=5.0)
        Adjust the layout of the plot.
    - title: str, optional (default=</span><span class="sh">'</span><span class="s">Feature Importance</span><span class="sh">'</span><span class="s">)
        Title of the plot.
    - xlabel: str, optional (default=</span><span class="sh">'</span><span class="s">Features</span><span class="sh">'</span><span class="s">)
        Label for the x-axis.
    - ylabel: str, optional (default=</span><span class="sh">'</span><span class="s">Importance</span><span class="sh">'</span><span class="s">)
        Label for the y-axis.
    - palette: list, optional
        A list of two colors. The first color is for bars 
        below the threshold and the second is for bars above.

    Returns:
    - None (modifies ax in-place)
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">palette</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">]</span>
    
    <span class="n">blue</span><span class="p">,</span> <span class="n">red</span> <span class="o">=</span> <span class="n">palette</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">red</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">blue</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span>
    <span class="n">sns</span><span class="p">.</span><span class="nf">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">hue</span> <span class="o">=</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">])))</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> 
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div></div>

<p>To better understand the relationship between our target feature, <code class="language-plaintext highlighter-rouge">trip_duration</code>, and the other features, we explore two distinct statistical measures: mutual information and the Spearman correlation coefficient.</p>

<p>Mutual information evaluates the mutual dependence between two variables and captures both linear and non-linear relationships. This measure is robust against outliers and provides reliability for any numerical or categorical features. On the other hand, Spearman correlation, while also addressing both linear and non-linear relationships, does not assume any specific data distribution. We can interpret the comparison of these metrics as follows:</p>

<ul>
  <li>
    <p>If mutual information has a strong relationship and weak Spearman correlation:  can suggest the presence of a complex, non-linear or non-monotonic relationship. Mutual information captures all kinds of dependencies, including non-linear ones, so it can detect relationships that Spearman correlation might miss if they don’t involve consistently increasing or decreasing ranks.</p>
  </li>
  <li>
    <p>If mutual information has a weak relationship and strong Spearman correlation: can suggests a monotonic relationship. Spearman correlation assesses how well the relationship between two variables can be described by a monotonic function, which means as one variable increases, the other also consistently increases (or decreases).</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">features_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pickup_date</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dropoff_date</span><span class="sh">'</span><span class="p">,</span> <span class="sh">"</span><span class="s">year</span><span class="sh">"</span><span class="p">,</span> 
                    <span class="sh">"</span><span class="s">min_of_day</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">hour</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">day_of_year</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">minute</span><span class="sh">"</span> <span class="p">]</span>
<span class="n">df_train_dropped</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">features_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">copy</span><span class="p">()</span>

<span class="c1"># Sample 50% with Random permutation
</span><span class="n">sample_size</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">permutation</span><span class="p">(</span><span class="n">df_train_large</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">sample_indices</span> <span class="o">=</span> <span class="n">random_indices</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>

<span class="c1"># Create a sample DataFrame
</span><span class="n">df_sampled</span> <span class="o">=</span> <span class="n">df_train_dropped</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">].</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">Y_train_large</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">Y_sampled</span> <span class="o">=</span> <span class="n">Y_train_large</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sample_indices</span><span class="p">]</span>

<span class="c1"># Mutual information
</span><span class="n">mi_values</span> <span class="o">=</span> <span class="nf">mutual_info_classif</span><span class="p">(</span><span class="n">df_sampled</span><span class="p">,</span> <span class="n">Y_sampled</span><span class="p">,</span> <span class="n">discrete_features</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">mi_column</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>   <span class="n">mi_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="nc">Index</span><span class="p">(</span><span class="n">df_sampled</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">),</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">mutual_inf</span><span class="sh">'</span><span class="p">]).</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">mutual_inf</span><span class="sh">'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">mi_column_reset</span> <span class="o">=</span> <span class="n">mi_column</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>

<span class="c1"># Spearmann correlation
</span><span class="n">spearman_corr</span> <span class="o">=</span> <span class="n">df_train_dropped</span><span class="p">.</span><span class="nf">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">spearman</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="nf">agg</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">abs</span><span class="p">)</span>\
                                                <span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
                                                <span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">)</span>\
                                                <span class="p">.</span><span class="nf">to_frame</span><span class="p">()</span>                                        
<span class="n">spearman_column</span> <span class="o">=</span> <span class="n">spearman_corr</span><span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>
<span class="n">spearman_column</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">spearman_corr</span><span class="sh">'</span><span class="p">]</span>


<span class="c1"># Plots
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">mi_column_reset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">mutual_inf</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Mutual Information</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span> 
                        <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Taxi Trip Duration Correlation</span><span class="sh">"</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">yellow</span><span class="p">,</span> <span class="n">orange</span><span class="p">])</span>

<span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">spearman_column</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">spearman_corr</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Spearman Correlation</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span> 
                        <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Taxi Trip Duration Correlation</span><span class="sh">"</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">yellow</span><span class="p">,</span> <span class="n">orange</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/mi_bar_plot.png" width="800" height="400" />
</center>

<p>The strongest correlation for <code class="language-plaintext highlighter-rouge">trip_duration</code> are the distance measures, <code class="language-plaintext highlighter-rouge">geodesic_distance</code> and <code class="language-plaintext highlighter-rouge">center_geodesic_distances</code>, as expected. The other features compared to the distances are less correlated, but yet have some relevance. Most of those features are related with pickup and dropoff locations.</p>

<ul>
  <li>
    <p>The two metrics show that most of the feature location have a strong correlation, but they do not agree with some features locations. For this purpose we could create a plot only for those features for a clear understanding of the correlation. I will skip this step for now.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">bearing</code> shows a much more strong correlation in the mutual information than the Spearman. In both plots the bearing is less correlated then the location features. This can suggest the bearing has a more complex, non-linear or non-monotonic relationship with <code class="language-plaintext highlighter-rouge">trip_duration</code>. This could be explained due to the directional effects that aren’t increasing or decreasing with time, because the bearing only provides the angle from the direction of pickup to the dropoff locations.</p>
  </li>
  <li>
    <p>The majority of climate features do not have a strong correlation with the target feature, with exception for the <code class="language-plaintext highlighter-rouge">visibility</code> and <code class="language-plaintext highlighter-rouge">temperature</code> features. For <code class="language-plaintext highlighter-rouge">visibility</code> we have a strong correlation for the mutual information and a weak correlation for Spearman, suggesting a complex, non-linear or non-monotonic relationship. For <code class="language-plaintext highlighter-rouge">temperature</code>, the opposite happens, suggesting a more monotonic relationship, that could be explained when extreme temperatures could consistently affect traffic patterns.</p>
  </li>
  <li>
    <p>Almost all temporal features do not show a strong correlation with the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code> for mutual information. However, for the Spearman correlation, the temporal features  <code class="language-plaintext highlighter-rouge">hour_of_day</code>, <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">is_weekend</code> and <code class="language-plaintext highlighter-rouge">day_of_week</code>, <code class="language-plaintext highlighter-rouge">is_holliday</code> show a better correlation, suggesting a monotonic relationship. This is expected because temporal features can increase or decrease traffic related to the time of day, month, weekends, and days of the week.</p>
  </li>
</ul>

<p>We can consider selecting two sets of relevant features from both metrics, and than take the union of these two sets. This will ensure that we select features that are relevant for both metrics.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">best_spearman</span> <span class="o">=</span> <span class="n">spearman_corr</span><span class="p">[</span><span class="n">spearman_corr</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">].</span><span class="n">index</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Best Spearman features for trip_duration correlation:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">best_spearman</span><span class="p">)</span>

<span class="n">best_mi</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">mi_column</span><span class="p">[</span><span class="n">mi_column</span><span class="p">[</span><span class="sh">'</span><span class="s">mutual_inf</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">].</span><span class="n">index</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s"> Best mutual information features for trip_duration:</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">best_mi</span><span class="p">)</span>


<span class="n">mi_set</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">best_mi</span><span class="p">)</span>
<span class="n">spearman_set</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">best_spearman</span><span class="p">)</span>

<span class="n">union_mi_spearman</span>  <span class="o">=</span> <span class="n">mi_set</span><span class="p">.</span><span class="nf">union</span><span class="p">(</span><span class="n">spearman_set</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">Union set:</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="n">union_mi_spearman</span><span class="p">)</span>
<span class="n">intersec_mi_spearman</span>  <span class="o">=</span> <span class="n">mi_set</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="n">spearman_set</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="s">Intersection set:</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="n">intersec_mi_spearman</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Best Spearman features for trip_duration correlation:
 ['geodesic_distance', 'center_geodesic_distances', 'dropoff_latitude', 'dropoff_center_lat', 
 'pickup_latitude', 'pickup_center_lat', 'dropoff_center_lon', 'dropoff_longitude', 'temperature', 
 'is_weekend', 'pickup_cluster', 'month', 'hour_of_day', 'day_of_week', 'is_holiday', 'pickup_center_lon', 
 'pickup_longitude', 'is_rush_hour', 'passenger_count', 'bearing', 'store_and_fwd_flag']

 Best mutual information features for trip_duration:
 ['geodesic_distance', 'center_geodesic_distances', 'pickup_cluster', 'pickup_center_lon', 
 'pickup_center_lat', 'dropoff_center_lat', 'dropoff_center_lon', 'dropoff_cluster', 'pickup_longitude', 
 'dropoff_latitude', 'pickup_latitude', 'dropoff_longitude', 'visibility', 
 'passenger_count', 'bearing', 'vendor_id']

Union set:
 {'is_holiday', 'dropoff_center_lon', 'dropoff_center_lat', 'passenger_count', 'store_and_fwd_flag', 
 'pickup_longitude', 'hour_of_day', 'day_of_week', 'center_geodesic_distances', 'pickup_cluster', 
 'pickup_latitude', 'dropoff_cluster', 'pickup_center_lat', 'dropoff_longitude', 'temperature', 
 'month', 'is_rush_hour', 'is_weekend', 'vendor_id', 'visibility', 'geodesic_distance', 
 'pickup_center_lon', 'bearing', 'dropoff_latitude'}

Intersection set:
 {'pickup_center_lat', 'dropoff_center_lon', 'dropoff_longitude', 'passenger_count', 'dropoff_center_lat', 
 'pickup_longitude', 'geodesic_distance', 'pickup_cluster', 'pickup_center_lon', 'center_geodesic_distances', 
 'bearing', 'dropoff_latitude', 'pickup_latitude'}
</code></pre></div></div>

<p>The intersection set has no feature related with climate feature. This confirm our previously assumption about the complex relationship between <code class="language-plaintext highlighter-rouge">visibility</code> and <code class="language-plaintext highlighter-rouge">temperature</code> with the target feature <code class="language-plaintext highlighter-rouge">trip_duration</code>. What it’s probably happening here is that mutual information can account for complex relation, but these features do not have a clear monotonic relationship necessary for a strong Spearman correlation. But we can still consider this features for our model, so we choose to use the union set of features to account both relevant feature in the two metrics.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_corr_ellipses</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Plots a correlation matrix using ellipses to represent the correlations.

    Parameters:
    - data (pd.DataFrame): A 2D array or DataFrame containing the correlation matrix.
    - figsize: Tuple specifying the figure size.
    - kwargs: Additional keyword arguments for EllipseCollection.

    Returns:
    - A tuple containing the EllipseCollection object and the Axes object.

    </span><span class="sh">"""</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">M</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">'</span><span class="s">Data must be a 2D array.</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Mask the upper triangle of the matrix
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">triu</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>

    <span class="c1"># Initialize the plot
</span>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">aspect</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">equal</span><span class="sh">'</span><span class="p">})</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">M</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">M</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Determine xy locations of each ellipse center
</span>    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">indices</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">shape</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">T</span>

    <span class="c1"># Define ellipse properties
</span>    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones_like</span><span class="p">(</span><span class="n">M</span><span class="p">).</span><span class="nf">ravel</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.01</span>  <span class="c1"># Widths of ellipses
</span>    <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">M</span><span class="p">).</span><span class="nf">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.01</span>   <span class="c1"># Heights of ellipses
</span>    <span class="n">a</span> <span class="o">=</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="n">M</span><span class="p">).</span><span class="nf">ravel</span><span class="p">()</span>        <span class="c1"># Rotation angles
</span>
    <span class="c1"># Create and add the ellipse collection
</span>    <span class="n">ec</span> <span class="o">=</span> <span class="nc">EllipseCollection</span><span class="p">(</span> <span class="n">widths</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">heights</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">xy</span><span class="p">,</span>
                            <span class="n">norm</span><span class="o">=</span><span class="nc">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">transOffset</span><span class="o">=</span><span class="n">ax</span><span class="p">.</span><span class="n">transData</span><span class="p">,</span> 
                            <span class="n">array</span><span class="o">=</span><span class="n">M</span><span class="p">.</span><span class="nf">ravel</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">add_collection</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>

    <span class="c1"># Add a color bar for correlation values
</span>    <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.047</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="n">cb</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_ticks_position</span><span class="p">(</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">cb</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_label_position</span><span class="p">(</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">cb</span><span class="p">.</span><span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Feature names on the diagonal
</span>    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">diagonal_positions</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">annotate</span><span class="p">(</span><span class="sh">"</span><span class="s"> -  </span><span class="sh">"</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="sh">'</span><span class="s">bottom</span><span class="sh">'</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_yticks</span><span class="p">(</span><span class="n">diagonal_positions</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_yticklabels</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Hide the plot spines
</span>    <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">.</span><span class="n">spines</span><span class="p">.</span><span class="nf">values</span><span class="p">():</span>
        <span class="n">spine</span><span class="p">.</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ec</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div></div>

<p>Let’s plot a special kind of heatmap using ellipses to better see the correlation between each feature. We choose to use the spearman correlation. The orientation of the ellipse indicates whether two variables are positively correlated (ellipse is pointed to the top right) or negatively correlated (ellipse is pointed to the top left). The shading and width of the ellipse indicate the strength of the association: thinner and darker ellipses correspond to stronger relationships. We choose to use the union set of features to account both relevant feature in the two metrics:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_train_union</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="nf">list</span><span class="p">(</span><span class="n">union_mi_spearman</span><span class="p">)].</span><span class="nf">copy</span><span class="p">()</span>

<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">df_train_union</span><span class="p">.</span><span class="nf">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">spearman</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Use the function with the Spearman correlation matrix
</span><span class="n">ec</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="nf">plot_corr_ellipses</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">PuOr</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/spearman_corr.png" width="800" height="700" />
</center>

<p>We can observe that some features are highly correlated, which may render certain features redundant for our model:</p>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">geodesic_distance</code> is highly correlated with <code class="language-plaintext highlighter-rouge">center_geodesic_distances</code>.</li>
  <li>All the pickup and dropoff location features are highly correlated with the pickup and dropoff cluster features.</li>
</ul>

<p>We have chosen to retain these features to evaluate their impact on the model’s performance.</p>

<h2 id="53-conclusion-from-eda">5.3 Conclusion from EDA</h2>

<p>The EDA revealed that Out of 39 features, with 28 having been crafted in the <a href="##3.-feature-engineering">Feature Engineering</a> section, a total of 24 were identified having some relevant correlation with the target feature or with another features. Let’s select the relevant features to train our machine learning models.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select relevant features from EDA and the target feature
</span><span class="n">relevant_features</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">union_mi_spearman</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">]</span>

<span class="n">df_train_processed</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="n">relevant_features</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">df_val_processed</span> <span class="o">=</span> <span class="n">df_val</span><span class="p">[</span><span class="n">relevant_features</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">df_test_processed</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="n">relevant_features</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">df_train_large_processed</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="n">relevant_features</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

<span class="c1"># Save the processed datasets with target feature
</span><span class="n">df_train_processed</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/train.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">df_val_processed</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/validation.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">df_test_processed</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/test.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">df_train_large_processed</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/train_large.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>We could see that the features  <code class="language-plaintext highlighter-rouge">geodesic_distance</code> and <code class="language-plaintext highlighter-rouge">center_geodesic_distances</code> have a strong and a positive correlation, yet they do not have linear correlation. This align with our conclusion that longer distances generally require longer travel times, but the relationship is not linear due to factors like traffic conditions. Also, certain direction was preferred for shorter trips, probably accounting trips within Manhattan borough. This could be seen for the <code class="language-plaintext highlighter-rouge">bearing</code> feature, which shows a complex  correlation with <code class="language-plaintext highlighter-rouge">trip_duration</code>. Those feature can be expected to be important for our model.</p>

<p>For Climate feature, most show a very weak correlation with <code class="language-plaintext highlighter-rouge">trip_duration</code>, except for <code class="language-plaintext highlighter-rouge">visibility</code> and <code class="language-plaintext highlighter-rouge">temperature</code>. Only this two features having a better correlation was contraintuitive, because was expected that more climate features could have a more strong correlation with <code class="language-plaintext highlighter-rouge">trip_duration</code>. Probably, because we only have records from the first 6 months of 2016, the impact of some climate features could not be fully captured, resulting in a weak correlation.</p>

<p>For temporal features, we could see that the <code class="language-plaintext highlighter-rouge">hour_of_day</code>, <code class="language-plaintext highlighter-rouge">month</code>, <code class="language-plaintext highlighter-rouge">is_weekend</code>, <code class="language-plaintext highlighter-rouge">day_of_week</code>, <code class="language-plaintext highlighter-rouge">is_holliday</code> show a better correlation with <code class="language-plaintext highlighter-rouge">trip_duration</code>, suggesting a monotonic relationship. This is expected because temporal features can increase or decrease traffic related to the time.</p>

<p>For pickup and dropoff locations features, we could see that the majority of the features show a good correlation with <code class="language-plaintext highlighter-rouge">trip_duration</code>. This is expected because the location features can indicate for our model traffic patterns related to the location.</p>

<h1 id="6-model-training-and-validation"><strong>6. Model Training and Validation</strong></h1>

<p>In this project, we choose to employ the XGBoost and Decision Tree Regressor models to train and predict the <code class="language-plaintext highlighter-rouge">taxi_trip_duration</code>. These models can capture complex relationships between the features and the target feature and they are robust against outliers. Even with our outliers handling, this kind of dataset can still have outliers due to unusual traffic conditions or other anomalies that we could not detect. In this section, We will use the <code class="language-plaintext highlighter-rouge">df_train</code> dataset to train the models and the <code class="language-plaintext highlighter-rouge">df_val</code> dataset to validate the predictions.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the processed datasets for train, validation
</span><span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/train.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df_val</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/validation.csv</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Save Target feature
</span><span class="n">Y_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
<span class="n">Y_val</span> <span class="o">=</span> <span class="n">df_val</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
<span class="n">Y_train_log</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span>
<span class="n">Y_val_log</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">Y_val</span><span class="p">)</span>

<span class="c1"># Drop target feature
</span><span class="n">df_train</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df_val</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">.</span><span class="n">values</span>
<span class="n">X_val</span> <span class="o">=</span> <span class="n">df_val</span><span class="p">.</span><span class="n">values</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Decision Tree Regressor
</span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">min_samples_leaf</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">min_samples_split</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">dtr</span> <span class="o">=</span> <span class="nc">DecisionTreeRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

<span class="c1"># Grid Search using RMSE as scoring metric
</span><span class="n">rmse_scorer</span> <span class="o">=</span> <span class="nf">make_scorer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)),</span> 
                            <span class="n">greater_is_better</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="nc">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">dtr</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">rmse_scorer</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">grid_search</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train_log</span><span class="p">)</span>

<span class="c1"># Best parameters and score
</span><span class="n">best_params</span> <span class="o">=</span> <span class="n">grid_search</span><span class="p">.</span><span class="n">best_params_</span>
<span class="n">best_score</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">grid_search</span><span class="p">.</span><span class="n">best_score_</span><span class="p">)</span>  

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Best parameters found: </span><span class="sh">"</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Best RMSE score from Grid Search: </span><span class="sh">"</span><span class="p">,</span> <span class="n">best_score</span><span class="p">)</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">grid_search</span><span class="p">.</span><span class="n">best_estimator_</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">rmse_val</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">Y_val_log</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">))</span>

<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">grid_search</span><span class="p">.</span><span class="n">best_estimator_</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">rmse_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">Y_train_log</span><span class="p">,</span> <span class="n">Y_pred</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s"> Train-rmse:</span><span class="si">{</span><span class="n">rmse_train</span><span class="si">}</span><span class="s"> </span><span class="se">\t\t</span><span class="s"> Validation-rmse:</span><span class="si">{</span><span class="n">rmse_val</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Best parameters found:  {'max_depth': 10, 'min_samples_leaf': 2, 'min_samples_split': 5}
Best RMSE score from Grid Search:  0.6045244076485581

 Train-rmse:0.35810464512423246 		 Validation-rmse:0.3645839928468323
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dmatrix_train</span> <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nc">DMatrix</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Y_train_log</span><span class="p">)</span>
<span class="n">dmatrix_val</span>  <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nc">DMatrix</span><span class="p">(</span><span class="n">X_val</span> <span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Y_val_log</span><span class="p">)</span>
<span class="n">watchlist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dmatrix_train</span><span class="p">,</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="n">dmatrix_val</span><span class="p">,</span> <span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">)]</span>


<span class="n">parms</span> <span class="o">=</span> <span class="p">{</span>   <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">objective</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">reg:squarederror</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">eta</span><span class="sh">'</span>      <span class="p">:</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">subsample</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">lambda</span><span class="sh">'</span>  <span class="p">:</span><span class="mi">4</span><span class="p">,</span>  
            <span class="sh">'</span><span class="s">colsample_bytree</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">colsample_bylevel</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min_child_weight</span><span class="sh">'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">nthread</span><span class="sh">'</span>  <span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">eval_metric</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">rmse</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">seed</span><span class="sh">'</span><span class="p">:</span> <span class="n">random_state</span><span class="p">}</span>

<span class="n">evals_test_val</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span>  <span class="n">parms</span><span class="p">,</span> <span class="n">dmatrix_train</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">evals</span> <span class="o">=</span> <span class="n">watchlist</span><span class="p">,</span> 
                        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                        <span class="n">evals_result</span> <span class="o">=</span> <span class="n">evals_test_val</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s"> Score = </span><span class="si">{</span><span class="n">xgb_model</span><span class="p">.</span><span class="n">best_score</span><span class="si">:</span><span class="mf">1.5</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s"> n_boost_round = </span><span class="si">{</span><span class="n">xgb_model</span><span class="p">.</span><span class="n">best_iteration</span><span class="si">:</span><span class="n">d</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0]	train-rmse:0.56721	validation-rmse:0.56764
[50]	train-rmse:0.29455	validation-rmse:0.30990
[100]	train-rmse:0.27962	validation-rmse:0.30561
[150]	train-rmse:0.26882	validation-rmse:0.30426
[200]	train-rmse:0.26045	validation-rmse:0.30408
[246]	train-rmse:0.25376	validation-rmse:0.30415

 Score = 0.30402
 n_boost_round = 217
</code></pre></div></div>

<h1 id="7-model-evaluation-on-test-set"><strong>7. Model Evaluation on Test Set</strong></h1>

<p>The XGBoost model outperforms the Decision Tree Regressor in both the training and validation datasets. To verify that our model truly has predictive power and isn’t just overfitting, we’ll assess it against the <code class="language-plaintext highlighter-rouge">df_test</code> set. Additionally, we’ll compare its performance with the <code class="language-plaintext highlighter-rouge">df_train_large</code> set for a more comprehensive evaluation. Testing on the <code class="language-plaintext highlighter-rouge">df_train_large</code> set, helps confirm that our model’s effectiveness isn’t limited to the smaller <code class="language-plaintext highlighter-rouge">df_train</code> dataset. This dual approach of testing against the unseen data (<code class="language-plaintext highlighter-rouge">df_test</code>) and a larger training set (<code class="language-plaintext highlighter-rouge">df_train_large</code>) can confirm the predictive power of the model.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the processed datasets for train large and validation
</span><span class="n">df_train_large</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/train_large.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/test.csv</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Save Target feature
</span><span class="n">Y_train_large</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>
<span class="n">Y_train_large_log</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">Y_train_large</span><span class="p">)</span>
<span class="n">Y_test_log</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>

<span class="c1"># Drop target feature
</span><span class="n">df_train_large</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df_test</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">X_train_large</span> <span class="o">=</span> <span class="n">df_train_large</span><span class="p">.</span><span class="n">values</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">.</span><span class="n">values</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dmatrix_train_large</span> <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nc">DMatrix</span><span class="p">(</span><span class="n">X_train_large</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Y_train_large_log</span><span class="p">)</span>
<span class="n">dmatrix_test</span>  <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nc">DMatrix</span><span class="p">(</span><span class="n">X_test</span>   <span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">Y_test_log</span><span class="p">)</span>
<span class="n">watchlist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dmatrix_train_large</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_large</span><span class="sh">'</span><span class="p">),</span> <span class="p">(</span><span class="n">dmatrix_test</span><span class="p">,</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">)]</span>

<span class="n">parms</span> <span class="o">=</span> <span class="p">{</span>   <span class="sh">'</span><span class="s">max_depth</span><span class="sh">'</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> 
            <span class="sh">'</span><span class="s">objective</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">reg:squarederror</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">eta</span><span class="sh">'</span>      <span class="p">:</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">subsample</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">lambda</span><span class="sh">'</span>  <span class="p">:</span><span class="mi">4</span><span class="p">,</span>  
            <span class="sh">'</span><span class="s">colsample_bytree</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">colsample_bylevel</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min_child_weight</span><span class="sh">'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">nthread</span><span class="sh">'</span>  <span class="p">:</span><span class="mi">8</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">eval_metric</span><span class="sh">'</span><span class="p">:</span> <span class="sh">"</span><span class="s">rmse</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">seed</span><span class="sh">'</span><span class="p">:</span> <span class="n">random_state</span><span class="p">}</span>

<span class="n">evals_test_train</span><span class="o">=</span> <span class="p">{}</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="p">.</span><span class="nf">train</span><span class="p">(</span>    <span class="n">parms</span><span class="p">,</span> <span class="n">dmatrix_train_large</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">evals</span> <span class="o">=</span> <span class="n">watchlist</span><span class="p">,</span>
                            <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                            <span class="n">evals_result</span> <span class="o">=</span> <span class="n">evals_test_train</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="se">\n</span><span class="s"> Score = </span><span class="si">{</span><span class="n">xgb_model</span><span class="p">.</span><span class="n">best_score</span><span class="si">:</span><span class="mf">1.5</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s"> n_boost_round = </span><span class="si">{</span><span class="n">xgb_model</span><span class="p">.</span><span class="n">best_iteration</span><span class="si">:</span><span class="n">d</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0]	train_large-rmse:0.56734	test-rmse:0.56765
[50]	train_large-rmse:0.29908	test-rmse:0.30796
[100]	train_large-rmse:0.28683	test-rmse:0.30243
[150]	train_large-rmse:0.27813	test-rmse:0.30017
[200]	train_large-rmse:0.27132	test-rmse:0.29918
[250]	train_large-rmse:0.26580	test-rmse:0.29838
[300]	train_large-rmse:0.26079	test-rmse:0.29799
[350]	train_large-rmse:0.25593	test-rmse:0.29770
[400]	train_large-rmse:0.25169	test-rmse:0.29765
[412]	train_large-rmse:0.25070	test-rmse:0.29760

 Score = 0.29759
 n_boost_round = 382
</code></pre></div></div>

<h1 id="8-conclusion"><strong>8. Conclusion</strong></h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rmse_train</span> <span class="o">=</span> <span class="n">evals_test_val</span><span class="p">[</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">rmse</span><span class="sh">'</span><span class="p">]</span>
<span class="n">rmse_val</span> <span class="o">=</span> <span class="n">evals_test_val</span><span class="p">[</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">rmse</span><span class="sh">'</span><span class="p">]</span>

<span class="n">rmse_train_large</span> <span class="o">=</span> <span class="n">evals_test_train</span><span class="p">[</span><span class="sh">'</span><span class="s">train_large</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">rmse</span><span class="sh">'</span><span class="p">]</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">evals_test_train</span><span class="p">[</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">rmse</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># Calculating the number of epochs for all datasets
</span><span class="n">epochs_train</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">rmse_train</span><span class="p">))</span>
<span class="n">epochs_val</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">rmse_val</span><span class="p">))</span>
<span class="n">epochs_train_large</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">rmse_train_large</span><span class="p">))</span>
<span class="n">epochs_test</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">rmse_test</span><span class="p">))</span>

<span class="c1"># Create subplots
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plotting Train and Validation RMSE
</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">epochs_train</span><span class="p">,</span> <span class="n">rmse_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Train</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">orange</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">epochs_val</span><span class="p">,</span> <span class="n">rmse_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Validation</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Epochs</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Train vs Validation</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>

<span class="c1"># Plotting Train Large and Test RMSE
</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">epochs_train_large</span><span class="p">,</span> <span class="n">rmse_train_large</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Train Large</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">orange</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">epochs_test</span><span class="p">,</span> <span class="n">rmse_test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Test</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Epochs</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">RMSE</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Train Large vs Test</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/learning_curve.png" width="800" height="300" />
</center>

<p>The plots show the RMSE score over the number of epochs for the <code class="language-plaintext highlighter-rouge">df_train</code> and <code class="language-plaintext highlighter-rouge">df_val</code> on the left, and for the <code class="language-plaintext highlighter-rouge">df_train_large</code> and <code class="language-plaintext highlighter-rouge">df_test</code> on the right. There’s a small gap of approximately 0.05 between the training and validation/test RMSEs, which is typical as models tend to perform better on the data they have seen (training data). Both validation/test sets reach a plateau around 0.3 RMSE, which is expected with data the model has not seen before.</p>

<p>Overall, the model performs well on the test/validation set with a RMSE of approximately 0.30. The plots suggest that the model has predictive power and is learning without showing signs of overfitting or data leakage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">feature_importances</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="p">.</span><span class="nf">get_score</span><span class="p">(</span><span class="n">importance_type</span><span class="o">=</span><span class="sh">'</span><span class="s">gain</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Map indices to names
</span><span class="n">feature_importances_named</span> <span class="o">=</span> <span class="p">{</span><span class="n">relevant_features</span><span class="p">[</span><span class="nf">int</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">feature_importances</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
<span class="n">df_feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">feature_importances_named</span><span class="p">.</span><span class="nf">items</span><span class="p">()),</span> 
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">importance</span><span class="sh">'</span><span class="p">]).</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">importance</span><span class="sh">'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">df_feature_importance</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="sh">'</span><span class="s">features</span><span class="sh">'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sh">'</span><span class="s">importance</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span> <span class="mi">4</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">XGBoost Feature Importance</span><span class="sh">"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">,</span> 
                        <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">Information Gain</span><span class="sh">"</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">yellow</span><span class="p">,</span> <span class="n">orange</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/xgboost_corr.png" width="800" height="500" />
</center>

<p>The feature importance using Information Gain from the XGBoost model validates our <a href="##5.3.-conclusion-from-eda">EDA conclusions</a>. The <code class="language-plaintext highlighter-rouge">geodesic_distance</code> feature has the highest information gain as we would expect. On the other hand, the <code class="language-plaintext highlighter-rouge">center_geodesic_distance</code> has very low information gain, as we previously suggested due to the redundant information. When features are highly correlated, tree-based models favor one over the other during the training process.</p>

<p>The <code class="language-plaintext highlighter-rouge">hour_of_day</code>, <code class="language-plaintext highlighter-rouge">is_weekend</code>, <code class="language-plaintext highlighter-rouge">is_holiday</code>, and <code class="language-plaintext highlighter-rouge">day_of_week</code> indicate that temporal features are important for our model. These features probably can indicate an increase or decrease in traffic related to the time. For example, <code class="language-plaintext highlighter-rouge">is_weekend</code> can indicate to our model that traffic patterns for weekends can be quite different from weekdays, having more traffic at different hours of the day, as we observed in the <a href="##5.1.-feature-visualization">Feature Visualization</a> section.</p>

<p>The <code class="language-plaintext highlighter-rouge">dropoff_center_lat</code> among other dropoff and pickup features was chosen by the model as the most important feature. This was also expected given the high correlation between the pickup and dropoff location and the pickup and dropoff for center of the clusters.</p>

<p>Overall, the XGBoost feature importance plot seems to validate our EDA findings, which is a good sign that the model is learning and making predictions based on the data. This is also a good sign that the model is not overfitting or presenting any indications of data leakage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prediction  on test set the trained model
</span><span class="n">Y_test_pred_log</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">dmatrix_test</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># distributions
</span><span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span><span class="n">Y_test_pred_log</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span> <span class="n">grey</span> <span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">kdeplot</span><span class="p">(</span><span class="n">Y_test_log</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span> <span class="n">grey</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Trip Duration Distribution</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">legend</span><span class="p">([</span><span class="sh">'</span><span class="s">Predicted on Test</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Actual on Test</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># CDFs
</span><span class="n">sns</span><span class="p">.</span><span class="nf">ecdfplot</span><span class="p">(</span><span class="n">Y_test_pred_log</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Predict on Test</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">yellow</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">ecdfplot</span><span class="p">(</span><span class="n">Y_test_log</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Actual on Test</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">orange</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Trip Duration Cumulative Distribution</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">legend</span><span class="p">()</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<center>
<img src="/assets/img/post5/predict_distribution_cdf.png" width="800" height="400" />
</center>

<p>Finally, for a better visualization of how well our model is making predictions, we plot the distribution and the cumulative distribution of trip duration for the actual values in <code class="language-plaintext highlighter-rouge">Y_test</code> and the predicted values from the dataset <code class="language-plaintext highlighter-rouge">df_test</code>. Note that both plots consider the log1p of <code class="language-plaintext highlighter-rouge">trip_duration</code>. We can conclude that our model is making very good predictions, with an RMSE of 0.30, and a good distribution of the predicted values.</p>

<h1 id="9-deployment"><strong>9. Deployment</strong></h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Training logic inside the script train_model.py
</span><span class="n">xgb_model</span> <span class="o">=</span> <span class="nf">train_xgboost</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/train_large.csv</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Save the model
</span><span class="n">xgb_model</span><span class="p">.</span><span class="nf">save_model</span><span class="p">(</span><span class="sh">'</span><span class="s">../models/xgb_taxi_trip.json</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="91-testing-local-and-web-service">9.1 Testing Local and Web Service</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">../data/processed/test.csv</span><span class="sh">'</span><span class="p">).</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">trip_duration</span><span class="sh">'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">url_local</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://127.0.0.1:9696/predict</span><span class="sh">"</span>
<span class="c1"># Sample one trip to make prediction
</span><span class="n">trip</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="sh">'</span><span class="s">records</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Make a POST request to predict trip duration
</span><span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url_local</span><span class="p">,</span> <span class="n">json</span> <span class="o">=</span> <span class="n">trip</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'Trip Duration (hours:minutes:seconds)': '1:1:18'}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Render Clound URL
</span><span class="n">url_clound</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://taxi-trip-predict.onrender.com/predict</span><span class="sh">"</span>
<span class="n">trip</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="sh">'</span><span class="s">records</span><span class="sh">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url_clound</span><span class="p">,</span> <span class="n">json</span> <span class="o">=</span> <span class="n">trip</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'Trip Duration (hours:minutes:seconds)': '0:20:16'}
</code></pre></div></div>


  
    
<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://https-marcosbenicio-github-io-1.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>


    </div>

  </body>
</html>
